{% extends 'baseOrg.html' %}
{% load i18n %}
{% load static %}

{% block title %}
  {% trans "Dashboard" %}
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/homeOrg.css' %}" />
  <link rel="stylesheet" href="{% static 'css/list_ampel.css' %}" />
  <style>
    .dashboard-section {
      margin-bottom: 2rem;
    }
    
    .section-header {
      border-bottom: 2px solid #f8f9fa;
      padding-bottom: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #495057;
      margin: 0;
    }
    
    .card-compact {
      border: 1px solid #e9ecef;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .priority-high { border-left: 4px solid #dc3545; }
    .priority-medium { border-left: 4px solid #ffc107; }
    .priority-low { border-left: 4px solid #28a745; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">{% trans "Dashboard" %}</h1>
  </div>
  <button type="button" class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#stickyNoteModal" title="{% trans 'Sticky Notes für schnelle Notizen' %}">
    <i class="bi bi-sticky me-1"></i>{% trans "Neue Notiz" %}
    <i class="bi bi-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Sticky Notes für schnelle Notizen' %}"></i>
  </button>
</div>

<!-- Pending Change Requests Section -->
{% if pending_change_requests %}
<div class="dashboard-section">
  <div class="card card-compact">
    <div class="card-header bg-white border-bottom-0 d-flex align-items-center justify-content-between">
      <h2 class="section-title mb-0">
        <i class="bi bi-pencil-square me-2 text-warning"></i>
        {% trans "Änderungsvorschläge" %}
        <i class="bi bi-question-circle me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Ein Änderungsvorschlag für eine Einsatzstelle oder ein Einsatzland wurde eingereicht. Diese Änderungen kann genehmigt oder abgelehnt werden.' %}"></i>
      </h2>
      <a href="{% url 'change_requests' %}" class="btn btn-sm btn-warning rounded-3">
        <i class="bi bi-eye me-2"></i>{% trans "Alle anzeigen" %}
      </a>
    </div>
    
    <div class="card-body">
      <div class="row g-3">
        {% for request in pending_change_requests|slice:":3" %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card shadow-sm rounded-4 border border-1 border-light-subtle">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-2">
                  <i class="bi bi-{% if request.change_type == 'einsatzstelle' %}building{% else %}geo-alt{% endif %} text-warning"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-0">{{ request.get_object_name }}</h6>
                  <small class="text-muted">{{ request.get_change_type_display }}</small>
                </div>
              </div>
              <p class="text-muted small mb-2">
                <i class="bi bi-person me-1"></i>{{ request.requested_by.get_full_name|default:request.requested_by.username }}
              </p>
              <p class="text-muted small mb-3">
                <i class="bi bi-clock me-1"></i>{{ request.created_at|date:"d.m.Y H:i" }}
              </p>
              <a href="{% url 'review_change_request' request.id %}" class="btn btn-sm btn-primary rounded-3 w-100">
                <i class="bi bi-eye me-1"></i>{% trans "Prüfen" %}
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
        {% if pending_change_requests.count > 3 %}
        <div class="col-12">
          <div class="text-center">
            <a href="{% url 'change_requests' %}" class="btn btn-outline-warning rounded-3">
              {% trans "Alle" %} {{ pending_change_requests.count }} {% trans "Vorschläge anzeigen" %}
            </a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Sticky Notes & Pinned Items Section -->
{% if pinned_notizen or sticky_notes %}
<div class="dashboard-section">
  {% comment %} <div class="section-header">
    <h2 class="section-title">
      <i class="bi bi-pin-angle-fill me-2 text-primary"></i>
      {% trans "Angeheftete Notizen" %}
    </h2>
  </div> {% endcomment %}
  
  <div class="pin-wall p-4 bg-light rounded-4 border">
    <div class="row g-3">
      {% for notiz in sticky_notes %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
          <div class="sticky-note">
            <div class="pin"></div>
            <div class="note-content {% if notiz.priority == 2 %}bg-danger bg-opacity-10{% elif notiz.priority == 1 %}bg-warning bg-opacity-10{% else %}bg-success bg-opacity-10{% endif %}">
              <div class="note-header">
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    {{ notiz.date|date:'d.m.Y H:i' }}
                  </small>
                  {% if notiz.priority > 0 %}
                    <span class="priority-badge">
                      {% if notiz.priority == 1 %}!!{% else %}!!!{% endif %}
                    </span>
                  {% endif %}
                </div>
                <form method="post" action="{% url 'delete_sticky_note' %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="notiz_id" value="{{ notiz.id }}" />
                  <button type="submit" class="btn btn-sm btn-link text-danger p-0">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
              {{ notiz.notiz|linebreaks }}
            </div>
          </div>
        </div>
      {% endfor %}

      {% for notiz in pinned_notizen %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
          <div class="sticky-note">
            <div class="pin"></div>
            <div class="note-content bg-info bg-opacity-10">
              <div class="note-header">
                <div>
                  <h6 class="mb-1">
                    <span class="fi fi-{{ notiz.einsatzstelle.land.code|lower }} me-2"></span>
                    {{ notiz.einsatzstelle.name }}
                  </h6>
                  <small class="text-muted">
                    <i class="bi bi-person-circle me-1"></i>
                    {{ notiz.user.get_full_name|default:notiz.user.username }}
                    <i class="bi bi-clock ms-2 me-1"></i>
                    {{ notiz.date|date:'d.m.Y H:i' }}
                  </small>
                </div>
                <div class="d-flex gap-1">
                  <form method="post" action="{% url 'einsatzstellen_notiz' es_id=notiz.einsatzstelle.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="unpin" />
                    <input type="hidden" name="notiz_id" value="{{ notiz.id }}" />
                    <button type="submit" class="btn btn-sm btn-link text-primary p-0">
                      <i class="bi bi-pin-angle-fill"></i>
                    </button>
                  </form>
                  <a href="{% url 'einsatzstellen_notiz' es_id=notiz.einsatzstelle.id %}" class="btn btn-sm btn-link text-primary p-0">
                    <i class="bi bi-arrow-right"></i>
                  </a>
                </div>
              </div>
              {{ notiz.notiz|linebreaks }}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Tasks Overview Section -->
<div class="dashboard-section">
  {% comment %} <div class="section-header">
    <h2 class="section-title">
      <i class="bi bi-list-task me-2 text-primary"></i>
      {% trans "Aufgabenübersicht" %}
    </h2>
  </div> {% endcomment %}
  
  <div class="grid-2 gap-3">
    <!-- My Tasks -->
    {% if request.user.customuser.person_cluster.aufgaben %}
    <div class="card card-compact h-100">
      <div class="card-header bg-white border-bottom-0">
        <div class="d-flex justify-content-between align-items-center">
          <a href="{% url 'aufgaben' %}" class="text-decoration-none text-body">
          <h5 class="mb-0">
            <i class="bi bi-person-check me-2"></i>
              {% trans "Meine Aufgaben" %}
            </h5>
          </a>
          </h5>
          <span class="badge bg-primary rounded-pill">{{ my_open_tasks.count }}</span>
        </div>
      </div>
      <div class="card-body">
        {% if my_open_tasks %}
          <div class="list-group list-group-flush">
            <div class="row row-cols-1 row-cols-xxl-2 g-3">
                {% for task in my_open_tasks|slice:":4" %}
                    {% include 'components/task_card.html' with task=task %}
                {% endfor %}
            </div>
            {% comment %} {% for task in my_open_tasks|slice:":5" %}
              <div class="list-group-item px-0 border-0 py-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="me-auto">
                    <h6 class="mb-1">{{ task.aufgabe.name }}</h6>
                    <small class="text-muted">
                      {% if task.faellig %}
                        <i class="bi bi-calendar me-1"></i>
                        {{ task.faellig|date:'d.m.Y' }}
                      {% endif %}
                    </small>
                  </div>
                  <span class="badge {% if task.faellig < today %}bg-danger{% else %}bg-secondary{% endif %}">
                    {% if task.faellig < today %}{% trans "Überfällig" %}{% else %}{% trans "Offen" %}{% endif %}
                  </span>
                </div>
              </div>
            {% endfor %} {% endcomment %}
          </div>
          {% if my_open_tasks.count > 5 %}
            <div class="text-center mt-3">
              <a href="{% url 'aufgaben' %}" class="btn btn-sm btn-outline-primary">
                {% trans "Alle" %} {{ my_open_tasks.count }} {% trans "anzeigen" %}
              </a>
            </div>
          {% endif %}
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-check2-circle text-success mb-2" style="font-size: 2rem"></i>
            <p class="text-muted mb-0">{% trans "Keine offenen Aufgaben" %}</p>
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Organization Tasks -->
    <div class="card card-compact h-100">
      <div class="card-header bg-white border-bottom-0">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <a href="{% url 'list_aufgaben_table' %}" class="text-decoration-none text-body">
            <i class="bi bi-building me-2"></i>
            {% trans "Aufgabenmanagement" %}
            </h5>
            </a>
          <div>
            <span class="badge bg-warning rounded-pill me-1">{{ pending_tasks.count }}</span>
            <span class="badge bg-danger rounded-pill">{{ open_tasks.count }}</span>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if pending_tasks or open_tasks %}
          <!-- Custom Tab Navigation -->
          <div class="row mb-3 g-3" id="taskTabs" role="tablist">
            <div class="col-6">
              <button class="task-tab-card text-center p-3 bg-warning bg-opacity-10 rounded w-100 border-0 active" 
                      id="pending-tab" 
                      data-bs-toggle="tab" 
                      data-bs-target="#pending-pane" 
                      type="button" 
                      role="tab" 
                      aria-controls="pending-pane" 
                      aria-selected="true">
                <div class="h4 mb-1 text-warning">{{ pending_tasks.count }}</div>
                <small class="text-muted">
                  <i class="bi bi-clock me-1"></i>
                  {% trans "Pending" %}
                </small>
              </button>
            </div>
            <div class="col-6">
              <button class="task-tab-card text-center p-3 bg-danger bg-opacity-10 rounded w-100 border-0" 
                      id="overdue-tab" 
                      data-bs-toggle="tab" 
                      data-bs-target="#overdue-pane" 
                      type="button" 
                      role="tab" 
                      aria-controls="overdue-pane" 
                      aria-selected="false">
                <div class="h4 mb-1 text-danger">{{ open_tasks.count }}</div>
                <small class="text-muted">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  {% trans "Überfällig" %}
                </small>
              </button>
            </div>
          </div>

          <!-- Tab Content -->
          <div class="tab-content" id="taskTabsContent">
            <div class="tab-pane fade show active" 
                 id="pending-pane" 
                 role="tabpanel" 
                 aria-labelledby="pending-tab">
              <div class="list-group list-group-flush">
                {% for task in pending_tasks %}
                  <div class="list-group-item px-0 border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="me-auto">
                        <h6 class="mb-1">{{ task.aufgabe.name }}</h6>
                        <div class="d-flex flex-column gap-1">
                          <small class="text-muted">
                            <i class="bi bi-person me-1"></i>{{ task.user.get_full_name|default:task.user.username }}
                          </small>
                        </div>
                      </div>
                      <div class="d-flex flex-column gap-1 mx-2 align-items-end">
                        {% if task.faellig %}
                          <small class="text-muted">
                            <i class="bi bi-calendar-event me-1 text-primary"></i>
                            <span class="fw-medium">{% trans "Fällig" %}:</span> {{ task.faellig|date:'d.m.' }}
                          </small>
                        {% endif %}
                        {% if task.erledigt_am %}
                          <small class="text-muted">
                            <i class="bi bi-send me-1 text-primary"></i>
                            <span class="fw-medium">{% trans "Eingereicht" %}:</span> {{ task.erledigt_am|date:'d.m.' }}
                          </small>
                        {% endif %}
                      </div>
                      <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-success" 
                                onclick="markTaskAsDone(this, {{ task.id }})"
                                tooltip="true"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="{% trans 'Als erledigt markieren' %}">
                          <i class="bi bi-check"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
                {% if not pending_tasks %}
                  <div class="text-center py-4">
                    <i class="bi bi-check2-circle text-muted mb-2" style="font-size: 2rem"></i>
                    <p class="text-muted mb-0">{% trans "Keine pending Aufgaben" %}</p>
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="tab-pane fade" 
                 id="overdue-pane" 
                 role="tabpanel" 
                 aria-labelledby="overdue-tab">
              <div class="list-group list-group-flush">
                {% for task in open_tasks %}
                  <div class="list-group-item px-0 border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="me-auto">
                        <h6 class="mb-1">{{ task.aufgabe.name }}</h6>
                        <div class="d-flex flex-column gap-1">
                          <small class="text-muted">
                            <i class="bi bi-person me-1"></i>{{ task.user.get_full_name|default:task.user.username }}
                          </small>
                        </div>
                      </div>
                      <div class="d-flex flex-column gap-1 mx-2 align-items-end">
                        {% if task.faellig %}
                              <small class="text-danger">
                                <i class="bi bi-calendar-event me-1 text-primary"></i>
                                <span class="fw-medium">{% trans "Fällig" %}:</span> {{ task.faellig|date:'d.m.' }}
                              </small>
                            {% endif %}
                      </div>
                      <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="sendTaskReminder({{ task.id }})"
                                tooltip="true"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="{% trans 'Erinnerung senden' %}">
                          <i class="bi bi-envelope"></i>
                        </button>
                        <button class="btn btn-sm btn-success" 
                                onclick="markTaskAsDone(this, {{ task.id }}, true)"
                                tooltip="true"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="{% trans 'Als erledigt markieren' %}">
                          <i class="bi bi-check"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
                {% if not open_tasks %}
                  <div class="text-center py-4">
                    <i class="bi bi-check2-circle text-muted mb-2" style="font-size: 2rem"></i>
                    <p class="text-muted mb-0">{% trans "Keine überfälligen Aufgaben" %}</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-check2-circle text-success mb-2" style="font-size: 2rem"></i>
            <p class="text-muted mb-0">{% trans "Alle Aufgaben sind auf dem neuesten Stand" %}</p>
          </div>
        {% endif %}

        <div class="text-center mt-3 pt-3 border-top">
          <a href="{% url 'list_aufgaben_table' %}" class="btn btn-sm btn-outline-primary">
            {% trans "Aufgaben verwalten" %}
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status & Content Section -->
<div class="dashboard-section">
  {% comment %} <div class="section-header">
    <h2 class="section-title">
      <i class="bi bi-activity me-2 text-primary"></i>
      {% trans "Status & Inhalte" %}
    </h2>
  </div> {% endcomment %}
  
  <div class="row g-3">
    <!-- Recent Ampel Entries -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card card-compact h-100">
      <div class="card-header bg-white border-bottom-0">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <a href="{% url 'list_ampel' %}" class="text-decoration-none text-body">
          <h5 class="mb-0">
            <i class="bi bi-circle-fill me-2"></i>
              {% trans "Ampelmeldungen" %}
            </h5>
          </a>
          <small class="text-muted">{% trans "Letzte 5 Tage" %}</small>
        </div>
      </div>
      <div class="card-body">
        {% if recent_ampel_entries %}
          <div class="list-group list-group-flush">
            {% for entry in recent_ampel_entries|slice:":5" %}
              <div class="list-group-item px-0 border-0 py-2 cursor-pointer" onclick="showAmpelComment('{{ entry.date }}', '{{ entry.status }}', '{{ entry.comment|default:'-ohne Kommentar- '|escapejs }}', '{{ entry.user }}')">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="me-auto">
                    <div class="d-flex align-items-center mb-1 gap-1">
                      <span class="ampel-dot ampel-{{ entry.status }}"></span>
                      <strong>{{ entry.user.get_full_name|default:entry.user.username }}</strong>
                    </div>
                    {% if entry.comment %}
                      <small class="text-muted">{{ entry.comment|truncatewords:8 }}</small>
                    {% endif %}
                  </div>
                  <small class="text-muted">{{ entry.date|date:'d.m H:i' }}</small>
                </div>
              </div>

              {% if not forloop.last %}
              <hr class="my-2">
              {% endif %}
            {% endfor %}
            {% include 'components/ampel_modal.html' %}
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-traffic-light text-muted mb-2" style="font-size: 2rem"></i>
            <p class="text-muted mb-0">{% trans "Keine Meldungen" %}</p>
          </div>
          {% endif %}
          <div class="text-center mt-3">
            <a href="{% url 'list_ampel' %}" class="btn btn-sm btn-outline-primary">
              {% trans "Alle anzeigen" %}
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Posts -->
    {% if request.user.customuser.person_cluster.posts %}
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card card-compact h-100">
      <div class="card-header bg-white border-bottom-0">
        <div class="d-flex justify-content-between align-items-center">
          <a href="{% url 'posts_overview' %}" class="text-decoration-none text-body">
            <h5 class="mb-0">
                <i class="bi bi-newspaper me-2"></i>
                {% trans "Neueste Posts" %}
            </h5>
          </a>
        </div>
      </div>
      <div class="card-body">
        {% if posts %}
            {% for post in posts|slice:":4" %}
            <a href="{% url 'post_detail' post.id %}" class="text-decoration-none text-body">
              <div class="px-0 border-0 py-2">
                <h6 class="mb-1">{{ post.title }}</h6>
                <p class="mb-1 text-muted small">{{ post.text|truncatewords:15 }}</p>
                <small class="text-muted">
                  <i class="bi bi-person me-1"></i>{{ post.user.get_full_name|default:post.user.username }}
                  <i class="bi bi-calendar ms-2 me-1"></i>{{ post.date|date:'d.m.Y' }}
                </small>
              </div>
            </a>
            {% if not forloop.last %}
            <hr class="my-2">
            {% endif %}
            {% endfor %}
          <div class="text-center mt-3">
            <a href="{% url 'posts_overview' %}" class="btn btn-sm btn-outline-primary">
              {% trans "Alle Posts" %}
            </a>
          </div>
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-newspaper text-muted mb-2" style="font-size: 2rem"></i>
            <p class="text-muted mb-0">{% trans "Keine Posts vorhanden" %}</p>
          </div>
        {% endif %}
      </div>
      </div>
    </div>
    {% endif %}

    <!-- Recent Images -->
    {% if request.user.customuser.person_cluster.bilder %}
    <div class="col-12 col-lg-6">
      <div class="card card-compact h-100">
      <div class="card-header bg-white border-bottom-0">
        <div class="d-flex justify-content-between align-items-center">
          <a href="{% url 'bilder' %}" class="text-decoration-none text-body">
          <h5 class="mb-0">
            <i class="bi bi-images me-2"></i>
            {% trans "Neueste Bilder" %}
            </h5>
          </a>
        </div>
      </div>
      <div class="card-body">
        {% if gallery_images %}
          <!-- Image Carousel -->
          {% if gallery_images %}
              <div class="row g-3">
                  {% include 'bilder_show.html' with gallery_images=gallery_images small=True %}
              </div>
          {% else %}
              <div class="text-center py-4">
          <i class="bi bi-images text-muted mb-2" style="font-size: 2rem"></i>
                  <p class="text-muted mb-0">{% trans "Keine Bilder vorhanden" %}</p>
              </div>
          {% endif %}

          <div class="text-center mt-3">
            <a href="{% url 'bilder' %}" class="btn btn-sm btn-outline-primary">
              {% trans "Alle Bilder" %}
            </a>
          </div>
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-images text-muted mb-2" style="font-size: 2rem"></i>
            <p class="text-muted mb-0">{% trans "Keine Bilder vorhanden" %}</p>
          </div>
        {% endif %}
      </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Calendar Section -->
{% if request.user.customuser.person_cluster.calendar %}
  {% include 'components/calendar.html' %}
{% endif %}

<!-- Sticky Note Modal -->
<div class="modal fade" id="stickyNoteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Neue Notiz erstellen" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'create_sticky_note' %}" id="stickyNoteForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="notiz" class="form-label">{% trans "Notiz" %}</label>
            <textarea class="form-control" id="notiz" name="notiz" rows="4" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">{% trans "Priorität" %}</label>
            <div class="btn-group btn-group-sm w-100" role="group">
              <input type="radio" class="btn-check" name="priority" id="priority0" value="0" checked>
              <label class="btn btn-outline-secondary" for="priority0">{% trans "Normal" %}</label>
              
              <input type="radio" class="btn-check" name="priority" id="priority1" value="1">
              <label class="btn btn-outline-warning" for="priority1">{% trans "Hoch" %}</label>
              
              <input type="radio" class="btn-check" name="priority" id="priority2" value="2">
              <label class="btn btn-outline-danger" for="priority2">{% trans "Sehr Hoch" %}</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Abbrechen" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Speichern" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Include existing styles for sticky notes -->
<style>
  .pin-wall {
    border: 1px solid #dee2e6;
  }

  .sticky-note {
    position: relative;
    margin-bottom: 1rem;
  }

  .pin {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 20px;
    background: #dc3545;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .pin::after {
    content: '';
    position: absolute;
    inset: 50% 0 0 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: #fff;
    border-radius: 50%;
  }

  .note-content {
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: 0.2s ease;
  }

  .note-content:hover {
    transform: rotate(0.5deg) scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .priority-badge {
    font-size: 0.8rem;
    font-weight: bold;
    color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
    padding: 0.1rem 0.3rem;
    border-radius: 0.25rem;
  }

  /* Custom tab card styling */
  .task-tab-card {
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    outline: none;
  }

  .task-tab-card:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .task-tab-card:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
  }

  .task-tab-card.active {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border: 2px solid rgba(0,0,0,0.1) !important;
  }

  .task-tab-card.active.bg-warning {
    border-color: #ffc107 !important;
  }

  .task-tab-card.active.bg-danger {
    border-color: #dc3545 !important;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('notiz');
    const form = document.getElementById('stickyNoteForm');
    const modal = document.getElementById('stickyNoteModal');

    // Handle Enter key in textarea
    if (textarea) {
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          if (e.shiftKey) {
            return true;
          } else {
            e.preventDefault();
            form.submit();
          }
        }
      });
    }

    // Set focus on textarea when modal is shown
    if (modal) {
      modal.addEventListener('shown.bs.modal', function() {
        textarea.focus();
      });
    }

    // Handle tab card active states
    const tabCards = document.querySelectorAll('.task-tab-card');
    tabCards.forEach(card => {
      card.addEventListener('shown.bs.tab', function(e) {
        // Remove active class from all cards
        tabCards.forEach(c => c.classList.remove('active'));
        // Add active class to current card
        e.target.classList.add('active');
      });
    });
  });


  // Function to mark a task as done
  function markTaskAsDone(button, taskId, overdue = false) {
    const originalContent = button.innerHTML;

    // hide tooltip and show loading state
    button.removeAttribute('data-bs-original-title');
    button.removeAttribute('data-bs-toggle');
    button.removeAttribute('data-bs-placement');
    button.removeAttribute('tooltip');

    const tooltip = bootstrap.Tooltip.getInstance(button);
    if (tooltip) {
        tooltip.hide();
    }

    // Show loading state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;

    fetch('{% url "mark_task_as_done" %}?id=' + taskId, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Remove the task from the list with animation
        const taskItem = button.closest('.list-group-item');
        taskItem.style.transition = 'opacity 0.3s ease';
        taskItem.style.opacity = '0';
        
        setTimeout(() => {
          taskItem.remove();
          let headerBadge, tabBadge, tabTitle;

          if (!overdue) {
          // Update badge counts
            headerBadge = document.querySelector('.badge.bg-warning');
            tabBadge = document.querySelector('#pending-tab .badge.bg-warning');
            tabTitle = document.querySelector('#pending-tab .h4');
          } else {
            headerBadge = document.querySelector('.badge.bg-danger');
            tabBadge = document.querySelector('#overdue-tab .badge.bg-danger');
            tabTitle = document.querySelector('#overdue-tab .h4');
          }
          
          if (headerBadge) {
            const currentCount = parseInt(headerBadge.textContent);
            if (currentCount > 1) {
              headerBadge.textContent = currentCount - 1;
            } else {
              headerBadge.textContent = '0';
            }
          }
          
          if (tabBadge) {
            const currentCount = parseInt(tabBadge.textContent);
            if (currentCount > 1) {
              tabBadge.textContent = currentCount - 1;
            } else {
              tabBadge.textContent = '0';
            }
          }
          
          if (tabTitle) {
            const currentCount = parseInt(tabTitle.textContent);
            if (currentCount > 1) {
              tabTitle.textContent = currentCount - 1;
            } else {
              tabTitle.textContent = '0';
            }
          }
          
          // Check if no more pending tasks
          const pendingPane = document.getElementById('pending-pane');
          const remainingTasks = pendingPane ? pendingPane.querySelectorAll('.list-group-item') : [];
        }, 300);
        
        // Show success message
        showToast('{% trans "Aufgabe als erledigt markiert" %}', 'success');
      } else {
        // Restore button state
        button.innerHTML = originalContent;
        button.disabled = false;
        showToast(data.error || '{% trans "Fehler beim Markieren der Aufgabe" %}', 'error');
      }
    })
    .catch(error => {
      // Restore button state
      button.innerHTML = originalContent;
      button.disabled = false;
      showToast('{% trans "Netzwerkfehler" %}', 'error');
    });
  }

  // Function to send task reminder
  function sendTaskReminder(taskId) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // remove tooltip
    button.removeAttribute('data-bs-original-title');
    button.removeAttribute('data-bs-toggle');
    button.removeAttribute('data-bs-placement');
    button.removeAttribute('tooltip');
    
    const tooltip = bootstrap.Tooltip.getInstance(button);
    if (tooltip) {
        tooltip.hide();
    }

    // Show loading state
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;

    fetch('{% url "send_task_reminder" %}?id=' + taskId, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      // Restore button state
      button.innerHTML = originalContent;
      button.disabled = false;
      
      if (data.success) {
        showToast('{% trans "Erinnerung erfolgreich gesendet" %}', 'success');
        button.classList.add('btn-outline-success');
        button.classList.remove('btn-outline-primary');
        button.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
        button.setAttribute('data-bs-original-title', '{% trans "Erinnerung gesendet" %}');
        button.setAttribute('data-bs-toggle', 'tooltip');
        button.setAttribute('data-bs-placement', 'top');
        button.setAttribute('tooltip', 'true');
      } else {
        button.classList.add('btn-outline-danger');
        button.classList.remove('btn-outline-primary');
        button.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
        button.setAttribute('data-bs-original-title', data.error);
        button.setAttribute('data-bs-toggle', 'tooltip');
        button.setAttribute('data-bs-placement', 'top');
        button.setAttribute('tooltip', 'true');
        showToast(data.error || '{% trans "Fehler beim Senden der Erinnerung" %}', 'error');
      }
    })
    .catch(error => {
      // Restore button state
      button.innerHTML = originalContent;
      button.disabled = false;
      showToast('{% trans "Netzwerkfehler" %}', 'error');
    });
  }

  // Simple toast notification function
  function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to document
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 5000);
  }
</script>
{% endblock %}
