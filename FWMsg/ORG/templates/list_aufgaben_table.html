{% extends 'baseOrg.html' %}
{% load static %}
{% load i18n %}
{% block title %}
  {% trans 'Aufgaben' %}
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/list_aufgaben.css' %}" />
  <style>
    /* Essential styles that Bootstrap doesn't cover */
    .table-responsive {
      max-height: calc(100vh - 200px);
      overflow: auto;
    }
    
    /* Sticky first column */
    .table th:first-child,
    .table td:first-child {
      position: sticky;
      left: 0;
      background-color: var(--bs-body-bg);
      z-index: 2;
    }
    
    /* Sticky header */
    .table thead th {
      position: sticky;
      top: 0;
      background-color: var(--bs-body-bg);
      z-index: 1;
    }
    
    /* Extra z-index for the corner cell */
    .table thead th:first-child {
      z-index: 3;
    }
    
    /* Simplified tooltip styles */
    [data-tooltip] {
      position: relative;
    }
    
    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.25rem 0.5rem;
      background-color: var(--bs-dark);
      color: var(--bs-white);
      font-size: 0.875rem;
      border-radius: var(--bs-border-radius-sm);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      transition-delay: 0.4s;
    }
    
    /* Special tooltip positioning for add-all button */
    .data-tooltip-bottom[data-tooltip]::before {
      bottom: auto;
      top: 100%;
      margin-top: 5px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex gap-2 justify-content-between align-items-center flex-wrap">
    <h2>{% trans 'Aufgabenübersicht' %}</h2>
    {% include 'components/task_legend.html' %}
  </div>

  {% if error %}
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      {{ error }}
    </div>
  {% else %}
    <div class="card rounded-4">
      {% include 'components/task_filter.html' %}
      <div class="card-body p-2">
        {% include 'components/task_table.html' %}
      </div>
    </div>

    {% include 'components/task_country_modal.html' with countries=countries %}

    <!-- Delete Task Modal -->
    <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteTaskModalLabel">{% trans 'Aufgabe löschen' %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
              {% trans 'Die Datei' %} <strong id="deleteTaskFileName" class="text-break"></strong> {% trans 'der Aufgabe' %} <strong id="deleteTaskName"></strong> {% trans 'für' %} <strong id="deleteTaskFreiwilliger"></strong> {% trans 'wirklich löschen?' %}
            </p>
            <p class="text-danger">
              <i class="bi bi-exclamation-triangle-fill"></i> {% trans 'Diese Aktion kann nicht rückgängig gemacht werden!' %}
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Abbrechen' %}</button>
            <form id="deleteTaskForm" method="POST">
              {% csrf_token %}
              <input type="hidden" name="delete_file_of_aufgabe" id="deleteTaskId" />
              <button type="submit" class="btn btn-danger">{% trans 'Löschen' %}</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% include 'components/task_zwischenschritte_modal.html' %}

    <script>
      function showDeleteTaskModal(taskId, taskName, taskFileName, freiwilligerName) {
        const modal = document.getElementById('deleteTaskModal')
        const taskNameElement = document.getElementById('deleteTaskName')
        const taskFileNameElement = document.getElementById('deleteTaskFileName')
        const freiwilligerElement = document.getElementById('deleteTaskFreiwilliger')
        const deleteTaskId = document.getElementById('deleteTaskId')
      
        // Update modal content
        taskNameElement.textContent = taskName
        taskFileNameElement.textContent = taskFileName
        freiwilligerElement.textContent = freiwilligerName
      
        deleteTaskId.value = taskId
      
        // Show modal
        const bsModal = new bootstrap.Modal(modal)
        bsModal.show()
      }
      
      document.addEventListener('DOMContentLoaded', function () {
        const scrollToElement = document.getElementById('scroll-to')
        if (scrollToElement) {
          scrollToElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
        }

        // Add search functionality
        const searchInput = document.getElementById('userSearch')
        const tableRows = document.querySelectorAll('tbody tr')
        
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase()
          
          tableRows.forEach(row => {
            const userName = row.querySelector('th').textContent.toLowerCase()
            if (userName.includes(searchTerm)) {
              row.style.display = ''
            } else {
              row.style.display = 'none'
            }
          })
        })
      })
      
      function setTaskId(taskId, taskName) {
        document.getElementById('taskIdInput').value = taskId
        document.getElementById('task_name').innerHTML = taskName
      }
    </script>
  {% endif %}
  
  <script>
    // CSRF token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Helper function to update task state UI
    function updateTaskState(taskId, state) {
        const row = document.getElementById(`task-table-row-${taskId}`);
        const completed = document.getElementById(`completed-task-template-${taskId}`);
        const pending = document.getElementById(`pending-task-template-${taskId}`);
        const upcoming = document.getElementById(`upcoming-task-template-${taskId}`);
        
        if (!row) return;
        
        // Reset all background classes
        row.className = row.className.replace(/bg-(success|warning|danger|dark)\s+bg-opacity-(25|10)/g, '');
        
        // Hide all templates
        [completed, pending, upcoming].forEach(el => el?.classList.add('d-none'));
        
        // Apply state-specific styling and show correct template
        switch(state) {
            case 'pending':
                row.classList.add('bg-warning', 'bg-opacity-25');
                pending?.classList.remove('d-none');
                break;
            case 'completed':
                row.classList.add('bg-success', 'bg-opacity-25');
                completed?.classList.remove('d-none');
                break;
            case 'upcoming':
            default:
                row.classList.add('bg-dark', 'bg-opacity-10');
                upcoming?.classList.remove('d-none');
                break;
        }
    }

    // Update task status function
    function updateTaskStatus(aufgabeId, pending, erledigt) {
        fetch("{% url 'ajax_update_task_status' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                aufgabe_id: aufgabeId,
                pending: pending,
                erledigt: erledigt
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(data);
                
                // Update task state using helper function
                if (pending) {
                    updateTaskState(aufgabeId, 'pending');
                } else if (erledigt) {
                    updateTaskState(aufgabeId, 'completed');
                } else {
                    updateTaskState(aufgabeId, 'upcoming');
                }
                
                console.log('Task status updated successfully');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the task status.');
        });
    }

    // Delete task file function
    function deleteTaskFile(aufgabeId) {
        if (confirm('Are you sure you want to delete this file?')) {
            fetch("{% url 'ajax_delete_task_file' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    aufgabe_id: aufgabeId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the file.');
            });
        }
    }

    function sendTaskReminder(button, id) {
      fetch(`{% url 'send_task_reminder' %}?id=${id}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            button.classList.add('text-success', 'disabled')
            button.innerHTML = '<i class="bi bi-bell-fill"></i> {% trans "Erinnerung gesendet" %}'
          } else {
            button.classList.add('text-danger', 'disabled')
            button.innerHTML = '<i class="bi bi-bell-slash-fill"></i> {% trans "Fehler beim Senden der Erinnerung" %}'
          }
        })
    }

    // Show delete task modal (if you have a modal for this)
    function showDeleteTaskModal(aufgabeId, aufgabeName, fileName, userName) {
        if (confirm(`Delete file "${fileName}" for task "${aufgabeName}" from user "${userName}"?`)) {
            deleteTaskFile(aufgabeId);
        }
    }

    // Assign task to specific user
    function assignTask(userId, aufgabeId) {
        fetch("{% url 'ajax_assign_task' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                user_id: userId,
                aufgabe_id: aufgabeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while assigning the task.');
        });
    }

    // Assign task to all eligible users
    function assignTaskToAll(aufgabeId) {
        if (confirm('Are you sure you want to assign this task to all eligible users?')) {
            fetch("{% url 'ajax_assign_task_to_all' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    aufgabe_id: aufgabeId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = data.message;
                    if (data.errors && data.errors.length > 0) {
                        message += '\n\nWarnings:\n' + data.errors.join('\n');
                    }
                    // alert(message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while assigning tasks to all users.');
            });
        }
    }

    // Assign tasks by country
    function assignTasksByCountry() {
        const taskId = document.getElementById('taskIdInput').value;
        const countryId = document.getElementById('countrySelect').value;
        
        if (!countryId) {
            alert('Please select a country.');
            return;
        }
        
        fetch("{% url 'ajax_assign_tasks_by_country' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                aufgabe_id: taskId,
                country_id: countryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert(data.message);
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskCountryModal'));
                modal.hide();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while assigning tasks by country.');
        });
    }
  </script>
{% endblock %}
