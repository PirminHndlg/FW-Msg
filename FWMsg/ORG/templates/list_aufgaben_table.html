{% extends 'baseOrg.html' %}
{% load static %}
{% load i18n %}
{% block title %}
  {% trans 'Aufgaben' %}
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/list_aufgaben.css' %}" />
  <style>
    /* Essential styles that Bootstrap doesn't cover */
    .table-responsive {
      max-height: calc(100vh - 200px);
      overflow: auto;
    }
    
    /* Sticky first column */
    .table th:first-child,
    .table td:first-child {
      position: sticky;
      left: 0;
      background-color: var(--bs-body-bg);
      z-index: 2;
    }
    
    /* Sticky header */
    .table thead th {
      position: sticky;
      top: 0;
      background-color: var(--bs-body-bg);
      z-index: 1;
    }
    
    /* Extra z-index for the corner cell */
    .table thead th:first-child {
      z-index: 3;
    }
    
    /* Simplified tooltip styles */
    [data-tooltip] {
      position: relative;
    }
    
    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.25rem 0.5rem;
      background-color: var(--bs-dark);
      color: var(--bs-white);
      font-size: 0.875rem;
      border-radius: var(--bs-border-radius-sm);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      transition-delay: 0.4s;
    }
    
    /* Special tooltip positioning for add-all button */
    .data-tooltip-bottom[data-tooltip]::before {
      bottom: auto;
      top: 100%;
      margin-top: 5px;
    }
    
    [data-tooltip]:hover::before {
      opacity: 1;
      visibility: visible;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex gap-2 justify-content-between align-items-center flex-wrap">
    <h2>{% trans 'Aufgabenübersicht' %}</h2>
    {% include 'components/task_legend.html' %}
  </div>

  {% if error %}
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      {{ error }}
    </div>
  {% else %}
    <div class="card rounded-4">
      {% include 'components/task_filter.html' %}
      <div class="card-body p-2">
        {% include 'components/task_table.html' %}
      </div>
    </div>

    {% include 'components/task_country_modal.html' with countries=countries %}

    <!-- Delete Task Modal -->
    <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteTaskModalLabel">{% trans 'Aufgabe löschen' %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
              {% trans 'Die Datei' %} <strong id="deleteTaskFileName" class="text-break"></strong> {% trans 'der Aufgabe' %} <strong id="deleteTaskName"></strong> {% trans 'für' %} <strong id="deleteTaskFreiwilliger"></strong> {% trans 'wirklich löschen?' %}
            </p>
            <p class="text-danger">
              <i class="bi bi-exclamation-triangle-fill"></i> {% trans 'Diese Aktion kann nicht rückgängig gemacht werden!' %}
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Abbrechen' %}</button>
            <form id="deleteTaskForm" method="POST">
              {% csrf_token %}
              <input type="hidden" name="delete_file_of_aufgabe" id="deleteTaskId" />
              <button type="submit" class="btn btn-danger">{% trans 'Löschen' %}</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% include 'components/task_zwischenschritte_modal.html' %}

    <script>
      function showDeleteTaskModal(taskId, taskName, taskFileName, freiwilligerName) {
        const modal = document.getElementById('deleteTaskModal')
        const taskNameElement = document.getElementById('deleteTaskName')
        const taskFileNameElement = document.getElementById('deleteTaskFileName')
        const freiwilligerElement = document.getElementById('deleteTaskFreiwilliger')
        const deleteTaskId = document.getElementById('deleteTaskId')
      
        // Update modal content
        taskNameElement.textContent = taskName
        taskFileNameElement.textContent = taskFileName
        freiwilligerElement.textContent = freiwilligerName
      
        deleteTaskId.value = taskId
      
        // Show modal
        const bsModal = new bootstrap.Modal(modal)
        bsModal.show()
      }
      
      document.addEventListener('DOMContentLoaded', function () {
        const scrollToElement = document.getElementById('scroll-to')
        if (scrollToElement) {
          scrollToElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
        }

        // Add search functionality
        const searchInput = document.getElementById('userSearch')
        const tableRows = document.querySelectorAll('tbody tr')
        
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase()
          
          tableRows.forEach(row => {
            const userName = row.querySelector('th').textContent.toLowerCase()
            if (userName.includes(searchTerm)) {
              row.style.display = ''
            } else {
              row.style.display = 'none'
            }
          })
        })
      })
      
      function setTaskId(taskId, taskName) {
        document.getElementById('taskIdInput').value = taskId
        document.getElementById('task_name').innerHTML = taskName
      }
    </script>
  {% endif %}
{% endblock %}
