{% extends 'baseOrg.html' %}
{% load static %}
{% load i18n %}
{% block title %}
  {% trans 'Aufgaben' %}
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/list_aufgaben.css' %}" />
  
  {# Global URL variables for JavaScript #}
  <script>
    // Define Django URL patterns as global variables for use in external JS files
    window.DJANGO_URLS = {
      editAufgabe: "{% url 'edit_object' 'aufgabe' 999999 %}".replace('/999999', '/{id}'),
      editUserAufgaben: "{% url 'edit_object' 'useraufgaben' 999999 %}".replace('/999999', '/{id}'),
      addAufgabe: "{% url 'add_aufgabe' %}",
      listAufgabenTable: "{% url 'list_aufgaben_table' %}",
      downloadAufgabe: "{% url 'download_aufgabe' 999999 %}".replace('/999999', '/{id}'),
      getAufgabenZwischenschritte: "{% url 'get_aufgaben_zwischenschritte' %}",
      toggleZwischenschrittStatus: "{% url 'toggle_zwischenschritt_status' %}",
    };
  </script>
  
  <script src="{% static 'js/loadAufgabenTable.js' %}"></script>
  <style>
    /* Table Layout & Responsive Design */
    .table-responsive {
      max-height: calc(100vh - 250px);
      overflow: auto;
    }
    
    /* Sticky Table Headers & First Column */
    .table th:first-child,
    .table td:first-child {
      position: sticky;
      left: 0;
      background-color: var(--bs-body-bg);
      z-index: 2;
    }
    
    .table thead th {
      position: sticky;
      top: 0;
      background-color: var(--bs-body-bg);
      z-index: 1;
    }
    
    .table thead th:first-child {
      z-index: 3;
    }
    
    /* Tooltip System */
    [data-tooltip] {
      position: relative;
    }
    
    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.25rem 0.5rem;
      background-color: var(--bs-dark);
      color: var(--bs-white);
      font-size: 0.875rem;
      border-radius: var(--bs-border-radius-sm);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      transition-delay: 0.4s;
    }
    
    /* Special tooltip positioning */
    .data-tooltip-bottom[data-tooltip]::before {
      bottom: auto;
      top: 100%;
      margin-top: 5px;
    }
    
    /* Loading Overlay Styles */
    #loadingState {
      position: relative;
    }
    
    #loadingState .card-body {
      position: relative;
    }
    
    /* Loading Animations */
    .spinner-border {
      animation: spinner-border 0.75s linear infinite;
    }
    
    /* Smooth transition for content switching */
    #actualContent {
      transition: opacity 0.3s ease-in-out;
    }
    
    #actualContent.show {
      opacity: 1;
    }
    
    /* Loading state positioning */
    .position-relative {
      position: relative;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex gap-2 justify-content-between align-items-center flex-wrap">
    <h2>{% trans 'Aufgabenübersicht' %}</h2>
    {% include 'components/task_legend.html' %}
  </div>

  {% if error %}
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      {{ error }}
    </div>
  {% else %}
    <!-- Main Content Container -->
    <div class="card rounded-4">
      <!-- Filter buttons (always visible) -->
      <div class="card-header bg-transparent border-bottom-0">
        <div class="d-flex gap-1 mb-2 justify-content-center align-items-center mt-2">
          <strong>{% trans "Benutzergruppe" %}</strong>
          <a href="{% url 'list_object' 'personcluster' %}" class="rounded-4"><i class="bi bi-pencil text-primary"></i></a>
          <div class="gap-1 flex-wrap justify-content-center align-items-center d-none d-md-flex">
            <a class="btn btn-sm rounded-4 btn-outline-primary {% if not current_person_cluster %}active{% endif %}" href="{% url 'list_aufgaben_table' %}?f=None&person_cluster_filter=None">
              {% trans "Alle" %}
            </a>
            {% for person_cluster in all_person_clusters %}
            <a class="btn btn-sm rounded-4 btn-outline-primary {% if current_person_cluster == person_cluster %}active{% endif %}" href="{% url 'list_aufgaben_table' %}?person_cluster_filter={{ person_cluster.id }}&f=None">
              {{ person_cluster.name }}
            </a>
            {% endfor %}
          </div>
          <div class="d-flex gap-1 flex-wrap justify-content-center align-items-center d-md-none">
            <select class="form-select form-select-sm rounded-4" onchange="window.location.href = this.value;">
              <option value="{% url 'list_aufgaben_table' %}?f=None&person_cluster_filter=None">{% trans 'Alle' %}</option>
              {% for person_cluster in all_person_clusters %}
                <option value="{% url 'list_aufgaben_table' %}?person_cluster_filter={{ person_cluster.id }}&f=None" {% if current_person_cluster == person_cluster %}selected{% endif %}>
                  {{ person_cluster.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        {% if aufgaben_cluster %}
        <div class="d-flex gap-1 mb-2 justify-content-center align-items-center mt-2">
          <strong>{% trans "Filter" %}</strong>
          <a href="{% url 'list_object' 'aufg-filter' %}" class="rounded-4"><i class="bi bi-pencil text-primary"></i></a>
          <div class="gap-1 flex-wrap justify-content-center align-items-center d-none d-md-flex">
            <!-- Filter buttons that work immediately -->
            <a class="btn btn-sm rounded-4 btn-outline-primary {% if not filter %}active{% endif %}" href="{% url 'list_aufgaben_table' %}?f=None&person_cluster_filter={{ current_person_cluster.id }}">
              {% trans "Alle" %}
            </a>
            {% for cluster in aufgaben_cluster %}
            <a class="btn btn-sm rounded-4 btn-outline-primary {% if filter == cluster %}active{% endif %}" href="{% url 'list_aufgaben_table' %}?f={{ cluster.id }}&person_cluster_filter={{ current_person_cluster.id }}">
              {{ cluster.name }}
            </a>
            {% endfor %}
          </div>
          <div class="d-flex gap-1 flex-wrap justify-content-center align-items-center d-md-none">
            <select class="form-select form-select-sm rounded-4" onchange="window.location.href = this.value;">
              <option value="{% url 'list_aufgaben_table' %}?f=None&person_cluster_filter={{ current_person_cluster.id }}">{% trans 'Alle' %}</option>
              {% for cluster in aufgaben_cluster %}
                <option value="{% url 'list_aufgaben_table' %}?f={{ cluster.id }}&person_cluster_filter={{ current_person_cluster.id }}" {% if filter == cluster %}selected{% endif %}>
                  {{ cluster.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}
      </div>
      
      <!-- Loading State Overlay -->
      <div id="loadingState" 
           class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-primary-subtle bg-opacity-75 loading-overlay" 
           style="z-index: 9999;" 
           role="dialog" 
           aria-modal="true" 
           aria-labelledby="loadingTitle">
        
        <!-- Loading Content Card -->
        <div class="d-flex flex-column align-items-center justify-content-center bg-white rounded-4 p-4 shadow">
          <!-- Loading Spinner -->
          <div class="spinner-border text-primary mb-3" 
               role="status" 
               style="width: 3rem; height: 3rem;" 
               aria-hidden="true">
            <span class="visually-hidden">{% trans "Laden..." %}</span>
          </div>
          
          <!-- Loading Title -->
          <h3 id="loadingTitle" class="text-muted mb-2 h5">
            {% trans "Aufgaben werden geladen..." %}
          </h3>
          
          <!-- Progress Bar -->
          <div class="progress mb-3" 
               style="width: 200px; height: 6px;" 
               role="progressbar" 
               aria-valuemin="0" 
               aria-valuemax="100">
            <div id="loadingProgress" 
                 class="progress-bar progress-bar-striped progress-bar-animated" 
                 style="width: 0%" 
                 aria-valuenow="0">
            </div>
          </div>
          
          <!-- Loading Status Text -->
          <small class="text-muted mb-3" id="loadingText">
            {% trans "Vorbereitung..." %}
          </small>
          
          <!-- Cancel Button -->
          <a href="{% url 'index_home' %}" 
             class="btn btn-outline-secondary btn-sm" 
             title="{% trans 'Laden abbrechen und zur Startseite zurückkehren' %}">
            <i class="bi bi-x-circle me-1" aria-hidden="true"></i>
            {% trans "Abbrechen" %}
          </a>
        </div>
      </div>

      <!-- Main Content Area -->
      <div id="actualContent" class="d-none">
        <!-- Dynamic content container for AJAX-loaded table -->
        <div id="dynamicContent" role="main" aria-live="polite">
          <!-- Table content will be populated via AJAX -->
        </div>
      </div>
    </div>

      {% include 'components/task_country_modal.html' with countries=countries %}

      <!-- Delete Task Modal -->
      <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteTaskModalLabel">{% trans 'Aufgabe löschen' %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>
                {% trans 'Die Datei' %} <strong id="deleteTaskFileName" class="text-break"></strong> {% trans 'der Aufgabe' %} <strong id="deleteTaskName"></strong> {% trans 'für' %} <strong id="deleteTaskFreiwilliger"></strong> {% trans 'wirklich löschen?' %}
              </p>
              <p class="text-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> {% trans 'Diese Aktion kann nicht rückgängig gemacht werden!' %}
              </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Abbrechen' %}</button>
              <form id="deleteTaskForm" method="POST">
                {% csrf_token %}
                <input type="hidden" name="delete_file_of_aufgabe" id="deleteTaskId" />
                <button type="submit" class="btn btn-danger">{% trans 'Löschen' %}</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      {% include 'components/task_zwischenschritte_modal.html' %}
    </div>

    <script>
      function showDeleteTaskModal(taskId, taskName, taskFileName, freiwilligerName) {
        const modal = document.getElementById('deleteTaskModal')
        const taskNameElement = document.getElementById('deleteTaskName')
        const taskFileNameElement = document.getElementById('deleteTaskFileName')
        const freiwilligerElement = document.getElementById('deleteTaskFreiwilliger')
        const deleteTaskId = document.getElementById('deleteTaskId')
      
        // Update modal content
        taskNameElement.textContent = taskName
        taskFileNameElement.textContent = taskFileName
        freiwilligerElement.textContent = freiwilligerName
      
        deleteTaskId.value = taskId
      
        // Show modal
        const bsModal = new bootstrap.Modal(modal)
        bsModal.show()
      }
      
      document.addEventListener('DOMContentLoaded', function () {
        // Handle loading state transition
        const loadingState = document.getElementById('loadingState')
        const actualContent = document.getElementById('actualContent')
        const loadingProgress = document.getElementById('loadingProgress')
        const loadingText = document.getElementById('loadingText')
        
        {% if ajax_loading %}
        // AJAX Loading Mode - Load data via AJAX
        loadDataViaAjax()
        
        // Add click handlers to filter buttons for AJAX loading
        addFilterClickHandlers()
        {% else %}
        // Traditional Loading Mode - Wait for server-rendered content
        loadDataTraditionally()
        {% endif %}
        
        function loadDataViaAjax() {
          const progressManager = new ProgressManager(loadingProgress, loadingText)
          
          const loadingSteps = [
            { progress: 20, text: "{% trans 'Aufgaben werden abgerufen...' %}" },
            { progress: 60, text: "{% trans 'Tabellendaten werden verarbeitet...' %}" },
            { progress: 80, text: "{% trans 'Benutzerdaten werden geladen...' %}" },
            { progress: 95, text: "{% trans 'Abschließende Vorbereitung...' %}" }
          ]
          
          // Start progress simulation
          progressManager.simulateProgress(loadingSteps)
          
          // Load data via AJAX
          let filterParam;
          const cookieFilter = getCookie('filter_aufgaben_table')
          if (cookieFilter) {
            filterParam = cookieFilter
          } else {
            filterParam = new URLSearchParams(window.location.search).get('f')
          }
          const personClusterParam = '{{current_person_cluster.id|default:None}}';
          fetch(`{% url 'ajax_load_aufgaben_table_data' %}?f=${filterParam}&person_cluster_filter=${personClusterParam}`, {
            method: 'GET',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Complete progress and render content
              progressManager.complete(() => {
                renderAjaxContent(data.data)
              })
            } else {
              // Handle error
              progressManager.cleanup()
              showError(data.error)
            }
          })
          .catch(error => {
            console.error('Error loading data:', error)
            showError('Fehler beim Laden der Daten')
          })
        }
        
        function loadDataTraditionally() {
          const progressManager = new ProgressManager(loadingProgress, loadingText)
          
          const loadingSteps = [
            { progress: 20, text: "{% trans 'Filter werden geladen...' %}" },
            { progress: 40, text: "{% trans 'Aufgaben werden abgerufen...' %}" },
            { progress: 60, text: "{% trans 'Tabellendaten werden verarbeitet...' %}" },
            { progress: 80, text: "{% trans 'Benutzerdaten werden geladen...' %}" },
            { progress: 95, text: "{% trans 'Abschließende Vorbereitung...' %}" }
          ]
          
          // Start progress simulation
          progressManager.simulateProgress(loadingSteps)
          
          // Function to show actual content and hide loading
          function showActualContent() {
            if (loadingState && actualContent) {
              progressManager.complete(() => {
                DOM.show(actualContent)
                DOM.setDisplay(loadingState, 'none')
              })
            }
          }
          
          // Check if content is ready (all images loaded, scripts executed)
          function checkContentReady() {
            
            // Wait for any async operations to complete
            const checkInterval = setInterval(() => {
              // Check if table rows are present and rendered
              const tableRows = actualContent.querySelectorAll('tbody tr')
              if (tableRows.length > 0) {
                clearInterval(checkInterval)
                // Add a small delay to ensure everything is rendered
                setTimeout(showActualContent, 500)
              }
            }, 100)
            
            // Fallback timeout in case something goes wrong
            setTimeout(() => {
              clearInterval(checkInterval)
              showActualContent()
            }, 8000)
          }
          
          // Start checking for content readiness
          checkContentReady()
        }
        
        const scrollToElement = document.getElementById('scroll-to')
        if (scrollToElement) {
          scrollToElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
        }
      })
      
      function setTaskId(taskId, taskName) {
        document.getElementById('taskIdInput').value = taskId
        document.getElementById('task_name').innerHTML = taskName
      }
    </script>
  {% endif %}
  
  <script>
    // ========================================
    // UTILITY FUNCTIONS & CONSTANTS
    // ========================================
    
    /**
     * Get CSRF token from cookies
     */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    /**
     * Unified progress management system
     */
    class ProgressManager {
        constructor(loadingProgress, loadingText) {
            this.loadingProgress = loadingProgress;
            this.loadingText = loadingText;
            this.currentStep = 0;
            this.progressValue = 0;
            this.timeouts = [];
        }

        updateProgress(progress, text) {
            if (this.loadingProgress) {
                this.loadingProgress.style.width = progress + '%';
                this.loadingProgress.setAttribute('aria-valuenow', progress);
            }
            if (this.loadingText && text) {
                this.loadingText.textContent = text;
            }
            this.progressValue = progress;
        }

        simulateProgress(steps, onComplete = null) {
            this.currentStep = 0;
            
            const simulate = () => {
                if (this.currentStep < steps.length) {
                    const step = steps[this.currentStep];
                    this.updateProgress(step.progress, step.text);
                    this.currentStep++;
                    
                    const delay = Math.random() * 800 + 400;
                    const timeout = setTimeout(simulate, delay);
                    this.timeouts.push(timeout);
                } else if (onComplete) {
                    onComplete();
                }
            };
            
            const initialTimeout = setTimeout(simulate, 300);
            this.timeouts.push(initialTimeout);
        }

        complete(onComplete = null) {
            this.updateProgress(100, "{% trans 'Fertig!' %}");
            if (onComplete) {
                setTimeout(onComplete, 300);
            }
        }

        cleanup() {
            this.timeouts.forEach(timeout => clearTimeout(timeout));
            this.timeouts = [];
        }
    }

    /**
     * DOM manipulation utilities
     */
    const DOM = {
        show: (element) => {
            if (element) {
                element.classList.remove('d-none');
                element.classList.add('show');
            }
        },
        
        hide: (element) => {
            if (element) {
                element.classList.add('d-none');
                element.classList.remove('show');
            }
        },
        
        setDisplay: (element, display) => {
            if (element) {
                element.style.display = display;
            }
        }
    };

    // ========================================
    // TASK MANAGEMENT FUNCTIONS
    // ========================================
    
    /**
     * Update task state UI elements
     */
    function updateTaskState(taskId, state) {
        const row = document.getElementById(`task-table-row-${taskId}`);
        const completed = document.getElementById(`completed-task-template-${taskId}`);
        const pending = document.getElementById(`pending-task-template-${taskId}`);
        const upcoming = document.getElementById(`upcoming-task-template-${taskId}`);
        
        if (!row) return;
        
        // Reset all background classes
        row.className = row.className.replace(/bg-(success|warning|danger|dark)\s+bg-opacity-(25|10)/g, '');
        
        // Hide all templates
        [completed, pending, upcoming].forEach(el => el?.classList.add('d-none'));
        
        // Apply state-specific styling and show correct template
        switch(state) {
            case 'pending':
                row.classList.add('bg-warning', 'bg-opacity-25');
                pending?.classList.remove('d-none');
                break;
            case 'completed':
                row.classList.add('bg-success', 'bg-opacity-25');
                completed?.classList.remove('d-none');
                break;
            case 'upcoming':
            default:
                row.classList.add('bg-dark', 'bg-opacity-10');
                upcoming?.classList.remove('d-none');
                break;
        }
    }

    // Update task status function
    function updateTaskStatus(aufgabeId, pending, erledigt) {
        fetch("{% url 'ajax_update_task_status' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                aufgabe_id: aufgabeId,
                pending: pending,
                erledigt: erledigt
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(data);
                
                // Update task state using helper function
                if (pending) {
                    updateTaskState(aufgabeId, 'pending');
                } else if (erledigt) {
                    updateTaskState(aufgabeId, 'completed');
                } else {
                    updateTaskState(aufgabeId, 'upcoming');
                }
                
                console.log('Task status updated successfully');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the task status.');
        });
    }

    // Delete task file function
    function deleteTaskFile(aufgabeId) {
        if (confirm('Are you sure you want to delete this file?')) {
            fetch("{% url 'ajax_delete_task_file' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    aufgabe_id: aufgabeId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the file.');
            });
        }
    }

    function sendTaskReminder(button, id) {
      fetch(`{% url 'send_task_reminder' %}?id=${id}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            button.classList.add('text-success', 'disabled')
            button.innerHTML = '<i class="bi bi-bell-fill"></i> {% trans "Erinnerung gesendet" %}'
          } else {
            button.classList.add('text-danger', 'disabled')
            button.innerHTML = '<i class="bi bi-bell-slash-fill"></i> {% trans "Fehler beim Senden der Erinnerung" %}'
          }
        })
    }

    // Show delete task modal (if you have a modal for this)
    function showDeleteTaskModal(aufgabeId, aufgabeName, fileName, userName) {
        if (confirm(`Delete file "${fileName}" for task "${aufgabeName}" from user "${userName}"?`)) {
            deleteTaskFile(aufgabeId);
        }
    }

    // Assign task to specific user
    function assignTask(userId, aufgabeId) {
        fetch("{% url 'ajax_assign_task' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                user_id: userId,
                aufgabe_id: aufgabeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while assigning the task.');
        });
    }

    // Assign task to all eligible users
    function assignTaskToAll(aufgabeId, personClusterId) {
        if (confirm('Are you sure you want to assign this task to all eligible users?')) {
            fetch("{% url 'ajax_assign_task_to_all' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    aufgabe_id: aufgabeId,
                    person_cluster_id: personClusterId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = data.message;
                    if (data.errors && data.errors.length > 0) {
                        message += '\n\nWarnings:\n' + data.errors.join('\n');
                    }
                    // alert(message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while assigning tasks to all users.');
            });
        }
    }

    // Assign tasks by country
    function assignTasksByCountry() {
        const taskId = document.getElementById('taskIdInput').value;
        const countryId = document.getElementById('countrySelect').value;
        
        if (!countryId) {
            alert('Please select a country.');
            return;
        }
        
        fetch("{% url 'ajax_assign_tasks_by_country' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                aufgabe_id: taskId,
                country_id: countryId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // alert(data.message);
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskCountryModal'));
                modal.hide();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while assigning tasks by country.');
        });
    }

    // ========================================
    // AJAX & LOADING MANAGEMENT
    // ========================================
    
    /**
     * Render AJAX-loaded content and handle transitions
     */
    function renderAjaxContent(data) {
      // Build table from JSON data using the new JavaScript approach
      const dynamicContent = document.getElementById('dynamicContent')
      if (dynamicContent) {
        // Use the buildTableFromJSON function from loadAufgabenTable.js
        const tableHtml = buildTableFromJSON(data)
        dynamicContent.innerHTML = tableHtml
      }
      
      // Update countries in modal if present
      if (data.countries) {
        updateCountriesModal(data.countries)
      }
      
      // Hide loading state and show actual content
      const loadingState = document.getElementById('loadingState')
      const actualContent = document.getElementById('actualContent')
      
      DOM.hide(loadingState)
      DOM.show(actualContent)
      
      // Update filter button states to match the loaded content
      updateFilterButtonStates()
      
      // Re-initialize any JavaScript functionality that might be needed
      initializeTableFunctionality()
    }
    
    /**
     * Update filter button active states based on current URL
     */
    function updateFilterButtonStates() {
      const currentUrl = new URL(window.location.href)
      const currentFilter = currentUrl.searchParams.get('f') || 'None'
      
      const filterButtons = document.querySelectorAll('.card-header a[href*="list_aufgaben_table"]')
      filterButtons.forEach(button => {
        const buttonUrl = new URL(button.href)
        const buttonFilter = buttonUrl.searchParams.get('f') || 'None'
        
        // Remove active class from all buttons
        button.classList.remove('active')
        
        // Add active class to the button that matches current filter
        if (buttonFilter === currentFilter) {
          button.classList.add('active')
        }
      })
    }
    
    function initializeTableFunctionality() {
      // Re-initialize tooltips and other interactive elements
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    }
    
    function searchHandler(value) {
      const searchTerm = value.toLowerCase()
      const tableRows = document.querySelectorAll('tbody tr')
      
      tableRows.forEach(row => {
        const userName = row.dataset.searchTerm
        if (userName && userName.toLowerCase().includes(searchTerm)) {
          row.style.display = ''
        } else {
          row.style.display = 'none'
        }
      })
    }
    
    function addFilterClickHandlers() {
      // Add click handlers to filter buttons in the card header
      const filterButtons = document.querySelectorAll('.card-header a[href*="list_aufgaben_table"]')
      filterButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault()
          
          // Get the filter value from the URL
          const url = new URL(this.href)
          const filterValue = url.searchParams.get('f') || 'None'
          
          // Update the URL without page reload
          window.history.pushState({}, '', this.href)
          
          // Show loading state
          showLoadingState()
          
          // Load new data with the filter
          loadDataWithFilter(filterValue)
        })
      })
    }
    
    function loadDataWithFilter(filterValue) {
      const loadingProgress = document.getElementById('loadingProgress')
      const loadingText = document.getElementById('loadingText')
      const progressManager = new ProgressManager(loadingProgress, loadingText)
      
      // Start progress simulation for filter loading
      const filterSteps = [
        { progress: 30, text: "{% trans 'Filter wird angewendet...' %}" },
        { progress: 60, text: "{% trans 'Daten werden neu geladen...' %}" },
        { progress: 90, text: "{% trans 'Tabelle wird aktualisiert...' %}" }
      ]
      progressManager.simulateProgress(filterSteps)
      
      fetch(`{% url 'ajax_load_aufgaben_table_data' %}?f=${filterValue}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Complete progress and render content
          progressManager.complete(() => {
            renderAjaxContent(data.data)
          })
        } else {
          // Handle error
          progressManager.cleanup()
          showError(data.error)
        }
      })
      .catch(error => {
        console.error('Error loading data:', error)
        progressManager.cleanup()
        showError('Fehler beim Laden der Daten')
      })
    }
    
    function showLoadingState() {
      const actualContent = document.getElementById('actualContent')
      const loadingState = document.getElementById('loadingState')
      const loadingProgress = document.getElementById('loadingProgress')
      const loadingText = document.getElementById('loadingText')
      
      // Hide actual content and show loading state
      DOM.hide(actualContent)
      DOM.setDisplay(loadingState, 'flex')
      
      // Reset progress
      if (loadingProgress) {
        loadingProgress.style.width = '0%'
        loadingProgress.setAttribute('aria-valuenow', 0)
      }
      if (loadingText) {
        loadingText.textContent = "{% trans 'Filter wird angewendet...' %}"
      }
    }
    
    function updateCountriesModal(countries) {
      const countrySelect = document.getElementById('countrySelect')
      if (!countrySelect) return
      
      countrySelect.innerHTML = ''
      countries.forEach(country => {
        const option = document.createElement('option')
        option.value = country.id
        option.textContent = country.name
        countrySelect.appendChild(option)
      })
    }
    
    function showError(message) {
      // Hide loading state
      const loadingState = document.getElementById('loadingState')
      DOM.setDisplay(loadingState, 'none')
      
      // Show error message
      const errorDiv = document.createElement('div')
      errorDiv.className = 'alert alert-danger'
      errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${message}`
      
      const container = document.querySelector('.container-fluid')
      if (container) {
        container.insertBefore(errorDiv, container.firstChild)
      }
    }
  </script>
{% endblock %}
