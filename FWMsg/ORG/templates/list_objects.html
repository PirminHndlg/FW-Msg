{% extends "baseOrg.html" %}
{% load list_objects_filters %}
{% load i18n %}

{% block head %}
<style>
    .table-responsive {
        scroll-behavior: smooth;
    }

    .table td {
        transition: background-color 0.2s ease;
    }

    .table-primary {
        transition: background-color 0.2s ease;
    }

    /* Sticky columns styling */
    .sticky-left-1 {
        position: sticky;
        left: 0;
        background: white;
        width: 120px;
    }

    .sticky-left-2 {
        position: sticky;
        left: var(--left-offset, 120px);
        background: white;
    }

    /* Ensure sticky columns stay on top */
    .table th.sticky-left-1,
    .table th.sticky-left-2 {
        z-index: 100;
    }

    /* Add shadow to indicate scrollable content */
    .sticky-left-2::after {
        content: '';
        position: absolute;
        top: 0;
        right: -2px;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to right, rgba(0,0,0,0.1), rgba(0,0,0,0));
    }
</style>
{% endblock %}


{% block content %}
<div class="row justify-content-between mb-3 align-items-center">
    <div class="col d-flex justify-content-between align-items-center">
        <div class="">
            <h2>{{ verbose_name }}</h2>
        </div>

        <div class="">
            <a href="{% url 'add_object' model_name %}">
                <button class="btn btn-sm rounded-4 btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>{% trans "Hinzuf√ºgen" %}
                </button>
            </a>
        </div>
    </div>

    <div class="col-md-6 col-lg-5 col-xl-4 col-sm-12 mt-1">
        <div class="input-group">
            <input type="text" class="form-control" id="mySearch" placeholder="Suche">
            <button class="btn btn-outline-primary" type="button">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
</div>

{% if error %}
    <div class="alert alert-danger">
        {{ error }}
    </div>
{% else %}

{% include "filter_form.html" %}


<div class="card rounded-4 p-1">
    <div>
        <small class="text-muted p-1 pb-0">insgesamt {{ objects.count }} {{ verbose_name }}</small>
        {% if model_name == 'freiwilliger' %}
            <small class="text-muted p-1 pb-0">
                <a href="{% url 'statistik' %}">Statistik</a>
            </small>
        {% endif %}
    </div>
    
    <div class="rounded-4 pt-0 overflow-x-auto" style="max-height: 80vh;">
        <table class="table table-hover mb-0 align-middle">
            <thead class="sticky-top z-1" style="background: white;">
                <tr>
                    {% for field in field_metadata %}
                    <th class="{% if field.name == 'first_name' or field.name == 'user_first_name' %}sticky-left-1{% elif field.name == 'last_name' or field.name == 'user_last_name' %}sticky-left-2{% endif %}">
                        {{ field.verbose_name }}
                    </th>
                    {% endfor %}
                    <th class="position-sticky" style="right: 0; background: white;"></th>
                </tr>
            </thead>
            <tbody id="myTable">
                {% for object in objects %}
                <tr data-pk="{{ object.pk }}" {% if object.pk == highlight_id %}id="highlight-row"{% endif %}>
                    {% for field in field_metadata %}
                    <td data-default="{{ object|get_attribute:field|default:'' }}" 
                        data-field="{{ field.name }}" 
                        class="{% if field.name == 'first_name' or field.name == 'user_first_name' %}sticky-left-1{% elif field.name == 'last_name' or field.name == 'user_last_name' %}sticky-left-2{% endif %} {% if object.pk == highlight_id %}table-primary{% endif %}">
                        {% if object|is_many_to_many:field.name %}
                            {% with items=object|get_attribute:field %}
                            {{ items.all|join:", " }}
                            {% endwith %}
                        {% else %}
                            {% if field.name == 'user' and object.user %}
                                <div class="d-flex align-items-center gap-1">
                                    <i class="bi bi-person"></i>
                                    <a href="{% url 'profil' object.user.pk %}">{{ object.user.username }}</a>
                                </div>
                            {% else %}
                            {% with field_type=object|get_field_type:field %}
                            {% with field_attribute=object|get_attribute:field %}

                                {% if field_type == 'BooleanField' %}
                                <div class="text-center">
                                    {% if field_attribute == True or field_attribute == 'True' %}
                                    <i class="bi bi-check text-white bg-success rounded"></i>
                                    {% else %}
                                    <i class="bi bi-x text-white bg-danger rounded"></i>
                                    {% endif %}
                                </div>
                                {% elif field_type == 'CharField' and field_attribute|length == 1 %}
                                    {% if object|has_choices:field %}
                                        {{ object|get_choice_label:field|default:'' }}
                                    {% else %}
                                        <div class="text-center">
                                            {{ field_attribute|default:'' }}
                                        </div>
                                    {% endif %}
                                {% elif field_type == 'DateField' or field_type == 'DateTimeField' %}
                                    {% if field_attribute%}
                                        <div class="d-flex align-items-center gap-1">
                                            <i class="bi bi-calendar"></i>
                                            {{ field_attribute|date:"d.m.Y"|default:field_attribute }}
                                        </div>
                                    {% endif %}
                                {% elif field_type == 'FileField' %}
                                    {% if field_attribute %}
                                        <i class="bi bi-file-earmark"></i>
                                    {% endif %}
                                {% elif field_type == 'PhoneNumberField' %}
                                    {% if field_attribute %}
                                    <div class="d-flex align-items-center gap-1 text-nowrap">
                                            <i class="bi bi-phone"></i>
                                            <a href="tel:{{ field_attribute }}">{{ field_attribute }}</a>
                                        </div>  
                                    {% endif %}
                                {% elif field_type == 'EmailField' %}
                                    {% if field_attribute %}
                                        <div class="d-flex align-items-center gap-1 text-nowrap">
                                            <i class="bi bi-envelope"></i>
                                            <a href="mailto:{{ field_attribute }}">{{ field_attribute }}</a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    {% if object|has_choices:field %}
                                        {{ object|get_choice_label:field|default:'' }}
                                    {% else %}
                                        {{ field_attribute|format_text_with_link|safe|default:'' }}
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                            {% endif %}

                        {% endif %}
                    </td>
                    {% endfor %}
                    <td class="position-sticky" style="right: 0; background: white;">
                        <div class="btn-group">
                            <a class="btn btn-sm btn-outline-primary"
                                href="{% url 'edit_object' model_name object.pk %}">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% if model_name == 'user' %}
                            {% csrf_token %}
                            <button type="button" id="sendRegistrationMailButton-{{ object.pk }}"
                                    class="btn btn-sm btn-outline-info d-flex align-items-center gap-1"
                                    onclick="sendRegistrationMail({{ object.pk }})"
                                    data-bs-toggle="tooltip"
                                    title="{% trans 'Send Registration Mail' %}">
                                <i class="bi bi-envelope"></i>
                            </button>
                            {% endif %}
                            <a class="btn btn-sm btn-outline-danger"
                                href="{% url 'delete_object' model_name object.pk %}"
                                onclick="return confirm('{% trans 'Are you sure you want to delete this item?' %}')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ field_metadata|length|add:1 }}" class="text-center">
                        {% trans "No items found" %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function sendRegistrationMail(userId) {
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement.value;
        
        fetch('{% url "send_registration_mail" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                userId: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const button = document.getElementById(`sendRegistrationMailButton-${userId}`);
                if (button) {
                    button.classList.add('btn-success', 'text-white', 'disabled');
                    button.classList.remove('btn-outline-info');
                    button.innerHTML = '<i class="bi bi-envelope"></i> <i class="bi bi-check"></i>';
                } else {
                    alert('{% trans "Erfolgreich gesendet!" %}');
                }

                const einmalpasswort = data.einmalpasswort;
                const td = button.closest('tr').querySelector('td[data-field="einmalpasswort"]');
                if (td) {
                    td.innerHTML = einmalpasswort;
                }
            } else {
                alert('{% trans "Fehler beim Senden der Registrierungsmail:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error sending registration mail" %}');
        });
    }

    // Calculate and set the left offset for the second sticky column
    document.addEventListener('DOMContentLoaded', function() {
        const firstStickyColumn = document.querySelector('.sticky-left-1');
        if (firstStickyColumn) {
            const width = firstStickyColumn.offsetWidth;
            document.documentElement.style.setProperty('--left-offset', width + 'px');
        }
    });

    $(document).ready(function () {
        $("#mySearch").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#myTable tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });

    {% if highlight_id %}
    document.addEventListener('DOMContentLoaded', function() {
        const highlightedRow = document.getElementById('highlight-row');
        if (highlightedRow) {
            // Wait a tiny bit to ensure the table is fully rendered
            setTimeout(() => {
                highlightedRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 100);

            // Fade out the highlight after 2 seconds
            setTimeout(() => {
                const tds = highlightedRow.querySelectorAll('td');
                tds.forEach(td => {
                    // First ensure the transition is visible by forcing a reflow
                    td.style.backgroundColor = window.getComputedStyle(td).backgroundColor;
                    // Then set the new background color
                    requestAnimationFrame(() => {
                        td.style.backgroundColor = 'var(--bs-body-bg)';
                        td.classList.remove('table-primary');
                    });
                });
            }, 3000);
        }
    });
    {% endif %}
</script>

{% endif %}

{% endblock %}