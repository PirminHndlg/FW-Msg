{% extends "baseOrg.html" %}
{% load list_objects_filters %}
{% load i18n %}

{% block head %}
<style>
    .table-responsive {
        scroll-behavior: smooth;
    }

    .table td {
        transition: background-color 0.2s ease;
    }

    .table-primary {
        transition: background-color 0.2s ease;
    }

    /* Sticky columns styling */
    .sticky-left-1 {
        position: sticky;
        left: 0;
        background: white;
        width: 120px;
    }

    .sticky-left-2 {
        position: sticky;
        left: var(--left-offset, 120px);
        background: white;
    }

    /* Ensure sticky columns stay on top */
    .table th.sticky-left-1,
    .table th.sticky-left-2 {
        z-index: 100;
    }

    /* Add shadow to indicate scrollable content */
    .sticky-left-2::after {
        content: '';
        position: absolute;
        top: 0;
        right: -2px;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to right, rgba(0,0,0,0.1), rgba(0,0,0,0));
    }
    
    /* Delete modal styles */
    .object-icon {
        width: 48px;
        height: 48px;
        min-width: 48px;
        background-color: rgba(var(--bs-danger-rgb), 0.1);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .cascade-list {
        border-color: #dee2e6 !important;
    }
</style>
{% endblock %}


{% block content %}
<div class="row justify-content-between mb-3 align-items-center">
    <div class="col d-flex justify-content-between align-items-center">
        <div class="">
            <h2>{{ verbose_name }}</h2>
        </div>

        <div class="">
            <a href="{% url 'add_object' model_name %}">
                <button class="btn btn-sm rounded-4 btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>{% trans "Hinzufügen" %}
                </button>
            </a>
        </div>
    </div>

    <div class="col-md-6 col-lg-5 col-xl-4 col-sm-12 mt-1">
        <div class="input-group">
            <input type="text" class="form-control" id="mySearch" placeholder="Suche">
            <button class="btn btn-outline-primary" type="button">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
</div>

{% if error %}
    <div class="alert alert-danger">
        {{ error }}
    </div>
{% else %}

{% include "filter_form.html" %}


<div class="card rounded-4 p-1">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <small class="text-muted p-1 pb-0">
                {% if page_obj.paginator.count != total_count %}
                    {% trans "Anzeige gefiltert:" %} {{ page_obj.paginator.count }} {% trans "von" %} {{ total_count }} {{ verbose_name }}
                {% else %}
                    {% trans "insgesamt" %} {{ total_count }} {{ verbose_name }}
                {% endif %}
            </small>
            {% if model_name == 'freiwilliger' %}
                <small class="text-muted p-1 pb-0">
                    <a href="{% url 'statistik' %}">Statistik</a>
                </small>
            {% endif %}
        </div>
        
        {% if page_obj.paginator.num_pages > 1 %}
        <div>
            <small class="text-muted">
                {% trans "Seite" %} {{ page_obj.number }} {% trans "von" %} {{ page_obj.paginator.num_pages }}
                ({% trans "Zeige" %} {{ page_obj.start_index }}-{{ page_obj.end_index }})
            </small>
        </div>
        {% endif %}
    </div>
    
    <div class="rounded-4 pt-0 overflow-x-auto" style="max-height: 80vh;">
        <table class="table table-hover mb-0 align-middle">
            <thead class="sticky-top z-1" style="background: white;">
                <tr>
                    {% for field in field_metadata %}
                    <th class="{% if field.name == 'first_name' or field.name == 'user_first_name' %}sticky-left-1{% elif field.name == 'last_name' or field.name == 'user_last_name' %}sticky-left-2{% endif %}">
                        {{ field.verbose_name }}
                    </th>
                    {% endfor %}
                    <th class="position-sticky" style="right: 0; background: white;"></th>
                </tr>
            </thead>
            <tbody id="myTable">
                {% for object in objects %}
                <tr data-pk="{{ object.pk }}" {% if object.pk == highlight_id %}id="highlight-row"{% endif %}>
                    {% for field in field_metadata %}
                    <td data-default="{{ object|get_attribute:field|default:'' }}" 
                        data-field="{{ field.name }}" 
                        class="{% if field.name == 'first_name' or field.name == 'user_first_name' %}sticky-left-1{% elif field.name == 'last_name' or field.name == 'user_last_name' %}sticky-left-2{% endif %} {% if object.pk == highlight_id %}table-primary{% endif %}">
                        {% if object|is_many_to_many:field.name %}
                            {% with items=object|get_attribute:field %}
                            {{ items.all|join:", " }}
                            {% endwith %}
                        {% else %}
                            {% if field.name == 'user' and object.user %}
                                <div class="d-flex align-items-center gap-1">
                                    <i class="bi bi-person"></i>
                                    <a href="{% url 'profil' object.user.pk %}">{{ object.user.username }}</a>
                                </div>
                            {% else %}
                            {% with field_type=object|get_field_type:field %}
                            {% with field_attribute=object|get_attribute:field %}

                                {% if field_type == 'BooleanField' %}
                                <div class="text-center">
                                    {% if field_attribute == True or field_attribute == 'True' %}
                                    <i class="bi bi-check text-white bg-success rounded"></i>
                                    {% else %}
                                    <i class="bi bi-x text-white bg-danger rounded"></i>
                                    {% endif %}
                                </div>
                                {% elif field_type == 'CharField' and field_attribute|length == 1 %}
                                    {% if object|has_choices:field %}
                                        {{ object|get_choice_label:field|default:'' }}
                                    {% else %}
                                        <div class="text-center">
                                            {{ field_attribute|default:'' }}
                                        </div>
                                    {% endif %}
                                {% elif field_type == 'DateField' or field_type == 'DateTimeField' %}
                                    {% if field_attribute%}
                                        <div class="d-flex align-items-center gap-1">
                                            <i class="bi bi-calendar"></i>
                                            {{ field_attribute|date:"d.m.Y"|default:field_attribute }}
                                        </div>
                                    {% endif %}
                                {% elif field_type == 'FileField' %}
                                    {% if field_attribute %}
                                        <i class="bi bi-file-earmark"></i>
                                    {% endif %}
                                {% elif field_type == 'PhoneNumberField' %}
                                    {% if field_attribute %}
                                    <div class="d-flex align-items-center gap-1 text-nowrap">
                                            <i class="bi bi-phone"></i>
                                            <a href="tel:{{ field_attribute }}">{{ field_attribute }}</a>
                                        </div>  
                                    {% endif %}
                                {% elif field_type == 'EmailField' %}
                                    {% if field_attribute %}
                                        <div class="d-flex align-items-center gap-1 text-nowrap">
                                            <i class="bi bi-envelope"></i>
                                            <a href="mailto:{{ field_attribute }}">{{ field_attribute }}</a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    {% if object|has_choices:field %}
                                        {{ object|get_choice_label:field|default:'' }}
                                    {% else %}
                                        {{ field_attribute|format_text_with_link|safe|default:'' }}
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                            {% endif %}

                        {% endif %}
                    </td>
                    {% endfor %}
                    <td class="position-sticky" style="right: 0; background: white;">
                        <div class="btn-group">
                            <a class="btn btn-sm btn-outline-primary"
                                href="{% url 'edit_object' model_name object.pk %}">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% if model_name == 'user' %}
                            {% csrf_token %}
                            <button type="button" id="sendRegistrationMailButton-{{ object.pk }}"
                                    class="btn btn-sm btn-outline-info d-flex align-items-center gap-1"
                                    onclick="sendRegistrationMail({{ object.pk }})"
                                    data-bs-toggle="tooltip"
                                    title="{% trans 'Send Registration Mail' %}">
                                <i class="bi bi-envelope"></i>
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-danger delete-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal"
                                data-model="{{ model_name }}"
                                data-id="{{ object.pk }}"
                                data-name="{{ object|get_display_name|default:object.pk }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ field_metadata|length|add:1 }}" class="text-center">
                        {% trans "No items found" %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if page_obj.paginator.num_pages > 1 %}
    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center p-2 border-top">
        <div>
            <small class="text-muted">
                {% trans "Zeige" %} {{ page_obj.start_index }}-{{ page_obj.end_index }} {% trans "von" %} {{ page_obj.paginator.count }}
            </small>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if query_string %}&{{ query_string }}{% endif %}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;&laquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;</span>
                    </li>
                {% endif %}
                
                {% for i in paginator.page_range %}
                    {% if page_obj.number == i %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ i }}</span>
                        </li>
                    {% elif i > page_obj.number|add:"-3" and i < page_obj.number|add:"3" %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ i }}{% if query_string %}&{{ query_string }}{% endif %}">{{ i }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query_string %}&{{ query_string }}{% endif %}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;&raquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
    function sendRegistrationMail(userId) {
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement.value;
        
        fetch('{% url "send_registration_mail" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                userId: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const button = document.getElementById(`sendRegistrationMailButton-${userId}`);
                if (button) {
                    button.classList.add('btn-success', 'text-white', 'disabled');
                    button.classList.remove('btn-outline-info');
                    button.innerHTML = '<i class="bi bi-envelope"></i> <i class="bi bi-check"></i>';
                } else {
                    alert('{% trans "Erfolgreich gesendet!" %}');
                }

                const einmalpasswort = data.einmalpasswort;
                const td = button.closest('tr').querySelector('td[data-field="einmalpasswort"]');
                if (td) {
                    td.innerHTML = einmalpasswort;
                }
            } else {
                alert('{% trans "Fehler beim Senden der Registrierungsmail:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error sending registration mail" %}');
        });
    }

    // Calculate and set the left offset for the second sticky column
    document.addEventListener('DOMContentLoaded', function() {
        const firstStickyColumn = document.querySelector('.sticky-left-1');
        if (firstStickyColumn) {
            const width = firstStickyColumn.offsetWidth;
            document.documentElement.style.setProperty('--left-offset', width + 'px');
        }
    });

    $(document).ready(function () {
        $("#mySearch").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#myTable tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });

    {% if highlight_id %}
    document.addEventListener('DOMContentLoaded', function() {
        const highlightedRow = document.getElementById('highlight-row');
        if (highlightedRow) {
            // Wait a tiny bit to ensure the table is fully rendered
            setTimeout(() => {
                highlightedRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 100);

            // Fade out the highlight after 2 seconds
            setTimeout(() => {
                const tds = highlightedRow.querySelectorAll('td');
                tds.forEach(td => {
                    // First ensure the transition is visible by forcing a reflow
                    td.style.backgroundColor = window.getComputedStyle(td).backgroundColor;
                    // Then set the new background color
                    requestAnimationFrame(() => {
                        td.style.backgroundColor = 'var(--bs-body-bg)';
                        td.classList.remove('table-primary');
                    });
                });
            }, 3000);
        }
    });
    {% endif %}
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header bg-danger bg-opacity-10 border-0 rounded-top-4">
                <h5 class="modal-title text-danger" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {% trans "Objekt löschen" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning rounded-3 mb-4">
                    <div class="d-flex">
                        <div class="me-3 fs-3">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">{% trans "Achtung: Löschen nicht rückgängig machbar!" %}</h5>
                            <p class="mb-0">{% trans "Sind Sie sicher, dass Sie dieses Objekt löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden." %}</p>
                        </div>
                    </div>
                </div>
                
                <h6 class="fw-bold">{% trans "Zu löschendes Objekt:" %}</h6>
                <div class="d-flex align-items-center p-3 bg-light rounded-3 mb-4">
                    <div class="object-icon me-3">
                        <i class="bi bi-trash fs-4 text-danger"></i>
                    </div>
                    <div>
                        <h6 class="mb-1" id="objectName"></h6>
                        <small class="text-muted">{{ verbose_name }} (ID: <span id="objectId"></span>)</small>
                    </div>
                </div>
                
                <div id="cascadeContainer" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">{% trans "Folgende Objekte werden auch gelöscht:" %}</h6>
                        <div class="spinner-border spinner-border-sm text-primary" role="status" id="cascadeSpinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="cascade-list overflow-auto p-0 border rounded" style="max-height: 300px;">
                        <div id="cascadeContent" class="list-group list-group-flush rounded-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>{% trans "Abbrechen" %}
                </button>
                <a href="#" id="deleteButton" class="btn btn-danger rounded-3">
                    <i class="bi bi-trash me-1"></i>{% trans "Endgültig löschen" %}
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // New script for handling the delete modal
    document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = document.getElementById('deleteModal');
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const cascadeContent = document.getElementById('cascadeContent');
        const cascadeSpinner = document.getElementById('cascadeSpinner');
        const deleteButton = document.getElementById('deleteButton');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modelName = this.getAttribute('data-model');
                const objectId = this.getAttribute('data-id');
                const objectName = this.getAttribute('data-name');
                
                // Update modal content
                document.getElementById('objectName').textContent = objectName;
                document.getElementById('objectId').textContent = objectId;
                deleteButton.href = `{% url 'delete_object' 'placeholder' 999 %}`.replace('placeholder', modelName).replace('999', objectId);
                
                // Clear previous cascade results
                cascadeContent.innerHTML = '';
                cascadeSpinner.style.display = 'block';
                
                // Fetch cascade information
                fetch(`{% url 'get_cascade_info' %}?model=${modelName}&id=${objectId}`)
                    .then(response => response.json())
                    .then(data => {
                        cascadeSpinner.style.display = 'none';
                        
                        if (data.cascade_objects && data.cascade_objects.length > 0) {
                            // Group cascade objects by model type
                            const groupedObjects = {};
                            data.cascade_objects.forEach(obj => {
                                if (!groupedObjects[obj.model]) {
                                    groupedObjects[obj.model] = [];
                                }
                                groupedObjects[obj.model].push(obj);
                            });
                            
                            // Create list items for each model type
                            Object.keys(groupedObjects).forEach(model => {
                                const modelItems = groupedObjects[model];
                                const modelGroup = document.createElement('div');
                                modelGroup.classList.add('list-group-item', 'p-0');
                                
                                const modelHeader = document.createElement('div');
                                modelHeader.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'p-3', 'bg-light', 'bg-opacity-50');
                                
                                const modelTitle = document.createElement('h6');
                                modelTitle.classList.add('mb-0');
                                modelTitle.innerHTML = `${model} <span class="badge bg-danger rounded-pill ms-2">${modelItems.length}</span>`;
                                
                                const toggleButton = document.createElement('button');
                                toggleButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'rounded-3');
                                toggleButton.innerHTML = '<i class="bi bi-chevron-down"></i>';
                                toggleButton.type = 'button';
                                toggleButton.setAttribute('data-bs-toggle', 'collapse');
                                toggleButton.setAttribute('data-bs-target', `#collapse-${model.replace(/\s+/g, '-')}`);
                                
                                modelHeader.appendChild(modelTitle);
                                modelHeader.appendChild(toggleButton);
                                modelGroup.appendChild(modelHeader);
                                
                                const itemsList = document.createElement('div');
                                itemsList.classList.add('collapse', 'show');
                                itemsList.id = `collapse-${model.replace(/\s+/g, '-')}`;
                                
                                // Add individual items
                                const itemsContainer = document.createElement('div');
                                itemsContainer.classList.add('list-group', 'list-group-flush', 'border-top');
                                
                                modelItems.forEach(item => {
                                    const itemElement = document.createElement('div');
                                    itemElement.classList.add('list-group-item', 'py-2', 'px-3');
                                    itemElement.innerHTML = `
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-dot text-danger fs-4"></i>
                                                <span>${item.display_name || 'ID: ' + item.id}</span>
                                            </div>
                                            <small class="text-muted">ID: ${item.id}</small>
                                        </div>
                                    `;
                                    itemsContainer.appendChild(itemElement);
                                });
                                
                                itemsList.appendChild(itemsContainer);
                                modelGroup.appendChild(itemsList);
                                cascadeContent.appendChild(modelGroup);
                            });
                        } else {
                            // No cascade objects
                            const noItemsMessage = document.createElement('div');
                            noItemsMessage.classList.add('list-group-item', 'py-3', 'text-center', 'text-muted');
                            noItemsMessage.innerHTML = '<i class="bi bi-info-circle me-2"></i>{% trans "Keine weiteren Objekte werden gelöscht" %}';
                            cascadeContent.appendChild(noItemsMessage);
                        }
                    })
                    .catch(error => {
                        cascadeSpinner.style.display = 'none';
                        console.error('Error fetching cascade information:', error);
                        
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('list-group-item', 'py-3', 'text-center', 'text-danger');
                        errorMessage.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>{% trans "Fehler beim Laden der Informationen" %}';
                        cascadeContent.appendChild(errorMessage);
                    });
            });
        });
    });
</script>

{% endif %}

{% endblock %}