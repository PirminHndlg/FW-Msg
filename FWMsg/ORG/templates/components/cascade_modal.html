{% load i18n %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header bg-danger bg-opacity-10 border-0 rounded-top-4">
                <h5 class="modal-title text-danger" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {% trans "Objekt löschen" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning rounded-3 mb-4">
                    <div class="d-flex">
                        <div class="me-3 fs-3">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">{% trans "Achtung: Löschen nicht rückgängig machbar!" %}</h5>
                            <p class="mb-0">{% trans "Sicher, dass Du dieses Objekt löschen möchtest? Diese Aktion kann nicht rückgängig gemacht werden." %}</p>
                        </div>
                    </div>
                </div>
                
                <h6 class="fw-bold">{% trans "Zu löschendes Objekt:" %}</h6>
                <div class="d-flex align-items-center p-3 bg-light rounded-3 mb-4">
                    <div class="object-icon me-3">
                        <i class="bi bi-trash fs-4 text-danger"></i>
                    </div>
                    <div>
                        <h6 class="mb-1" id="objectName"></h6>
                        <small class="text-muted">{{ verbose_name }} (ID: <span id="objectId"></span>)</small>
                    </div>
                </div>
                
                <div id="cascadeContainer" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">{% trans "Folgende Objekte werden auch gelöscht:" %}</h6>
                        <div class="spinner-border spinner-border-sm text-primary" role="status" id="cascadeSpinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="cascade-list overflow-auto p-0 border rounded" style="max-height: 300px;">
                        <div id="cascadeContent" class="list-group list-group-flush rounded-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>{% trans "Abbrechen" %}
                </button>
                <a href="#" id="deleteButton" class="btn btn-danger rounded-3">
                    <i class="bi bi-trash me-1"></i>{% trans "Endgültig löschen" %}
                </a>
            </div>
        </div>
    </div>
</div>



<script>
    // New script for handling the delete modal
    document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = document.getElementById('deleteModal');
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const cascadeContent = document.getElementById('cascadeContent');
        const cascadeSpinner = document.getElementById('cascadeSpinner');
        const deleteButton = document.getElementById('deleteButton');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log(this);
                const modelName = this.getAttribute('data-model');
                const objectId = this.getAttribute('data-id');
                const objectName = this.getAttribute('data-name');
                
                // Update modal content
                document.getElementById('objectName').textContent = objectName;
                document.getElementById('objectId').textContent = objectId;
                deleteButton.href = `{% url 'delete_object' 'placeholder' 999 %}`.replace('placeholder', modelName).replace('999', objectId);
                
                // Clear previous cascade results
                cascadeContent.innerHTML = '';
                cascadeSpinner.style.display = 'block';
                
                // Fetch cascade information
                fetch(`{% url 'get_cascade_info' %}?model=${modelName}&id=${objectId}`)
                    .then(response => response.json())
                    .then(data => {
                        cascadeSpinner.style.display = 'none';
                        
                        if (data.cascade_objects && data.cascade_objects.length > 0) {
                            // Display cascade objects with expandable details
                            data.cascade_objects.forEach((item, index) => {
                                const groupElement = document.createElement('div');
                                groupElement.classList.add('list-group-item', 'p-0');
                                
                                // Header with model name and count
                                const headerElement = document.createElement('div');
                                headerElement.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'p-3', 'cursor-pointer');
                                headerElement.style.cursor = 'pointer';
                                
                                const collapseId = `collapse-${index}`;
                                
                                headerElement.innerHTML = `
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-dot text-danger fs-4"></i>
                                        <div>
                                            <span class="fw-semibold">${item.count} ${item.model}</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary rounded-pill" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                        <i class="bi bi-chevron-down"></i> Details
                                    </button>
                                `;
                                
                                // Collapsible content with individual objects
                                const collapseElement = document.createElement('div');
                                collapseElement.classList.add('collapse');
                                collapseElement.id = collapseId;
                                
                                const objectsList = document.createElement('div');
                                objectsList.classList.add('list-group', 'list-group-flush', 'border-top');
                                
                                // Add individual objects
                                if (item.objects && item.objects.length > 0) {
                                    item.objects.forEach(obj => {
                                        const objElement = document.createElement('div');
                                        objElement.classList.add('list-group-item', 'py-2', 'px-4', 'small');
                                        objElement.innerHTML = `
                                            <i class="bi bi-arrow-return-right me-2 text-muted"></i>
                                            ${obj.display_name}
                                        `;
                                        objectsList.appendChild(objElement);
                                    });
                                } else {
                                    const noDetails = document.createElement('div');
                                    noDetails.classList.add('list-group-item', 'py-2', 'px-4', 'small', 'text-muted');
                                    noDetails.textContent = 'Keine Details verfügbar';
                                    objectsList.appendChild(noDetails);
                                }
                                
                                collapseElement.appendChild(objectsList);
                                
                                groupElement.appendChild(headerElement);
                                groupElement.appendChild(collapseElement);
                                cascadeContent.appendChild(groupElement);
                            });
                        } else {
                            // No cascade objects
                            const noItemsMessage = document.createElement('div');
                            noItemsMessage.classList.add('list-group-item', 'py-3', 'text-center', 'text-muted');
                            noItemsMessage.innerHTML = '<i class="bi bi-info-circle me-2"></i>{% trans "Keine weiteren Objekte werden gelöscht" %}';
                            cascadeContent.appendChild(noItemsMessage);
                        }
                    })
                    .catch(error => {
                        cascadeSpinner.style.display = 'none';
                        console.error('Error fetching cascade information:', error);
                        
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('list-group-item', 'py-3', 'text-center', 'text-danger');
                        errorMessage.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>{% trans "Fehler beim Laden der Informationen" %}';
                        cascadeContent.appendChild(errorMessage);
                    });
            });
        });
    });
</script>