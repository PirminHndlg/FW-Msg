{% load i18n %}

<div class="table-responsive" style="height: 100vh; min-height: 400px">
    <table class="table mb-0 align-middle table-borderless">
        <thead>
            {% include "components/task_table_header.html" %}
        </thead>
        <tbody>
            {% for user, user_aufgaben in user_aufgaben_matrix.items %}
                {% include "components/task_table_row.html" %}
            {% endfor %}
            <tr class="h-100"></tr>
        </tbody>
    </table>
</div>

<script>
  // Lazy loading of zwischenschritte data
  function loadZwischenschritte(taskId) {
    const btn = document.querySelector(`.btn-zwischenschritte[data-user-aufgabe-id="${taskId}"]`);
    if (btn && btn.dataset.loaded === 'false') {
      // Set loading state
      document.getElementById('zwischenschritteModalContent').innerHTML = `
        <div class="d-flex justify-content-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;
      
      // Fetch data
      fetch(`/org/get_aufgaben_zwischenschritte/?taskId=${taskId}`)
        .then(response => response.json())
        .then(data => {
          // Update modal content
          let content = `
            <h5>${data.task_name} - ${data.user_name}</h5>
            <ul class="list-group">
          `;
          
          if (data.zwischenschritte.length === 0) {
            content += `<li class="list-group-item">Keine Zwischenschritte definiert</li>`;
          } else {
            data.zwischenschritte.forEach(zs => {
              content += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${zs.name}</strong>
                    ${zs.beschreibung ? `<p class="mb-0 small text-muted">${zs.beschreibung}</p>` : ''}
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" 
                      onchange="toggleZwischenschritt(${taskId}, ${zs.id}, this.checked)"
                      ${zs.erledigt ? 'checked' : ''}
                    >
                  </div>
                </li>
              `;
            });
          }
          
          content += `</ul>`;
          document.getElementById('zwischenschritteModalContent').innerHTML = content;
          
          // Mark as loaded
          btn.dataset.loaded = 'true';
        })
        .catch(error => {
          console.error('Error loading zwischenschritte:', error);
          document.getElementById('zwischenschritteModalContent').innerHTML = `
            <div class="alert alert-danger">
              Fehler beim Laden der Zwischenschritte
            </div>
          `;
        });
    }
  }
  
  function toggleZwischenschritt(taskId, zwischenschrittId, status) {
    fetch('/org/toggle_zwischenschritt_status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        taskId: taskId,
        zwischenschrittId: zwischenschrittId,
        status: status
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update the UI if needed
        const btn = document.querySelector(`.btn-zwischenschritte[data-user-aufgabe-id="${taskId}"]`);
        if (data.zwischenschritte_done_open) {
          btn.textContent = data.zwischenschritte_done_open;
        }
        
        // Update cell class if all zwischenschritte are done
        if (data.zwischenschritte_done) {
          btn.closest('td').classList.add('table-success');
        } else {
          btn.closest('td').classList.remove('table-success');
        }
      }
    })
    .catch(error => console.error('Error toggling zwischenschritt:', error));
  }
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script> 