{% load i18n %}

{% for task in tasks %}
  <div class="list-group-item">
    <div class="d-flex w-100 justify-content-between align-items-center">
      <div>
        <h6 class="mb-1">{{ task.aufgabe }}</h6>
        <p class="mb-1 text-muted">{{ task.user.first_name }} {{ task.user.last_name }}</p>
      </div>

      <div class="d-flex align-items-center gap-2">
        {% if task.pending %}
          {% if task.file %}
            <a href="{% url 'download_aufgabe' task.id %}"
              class="btn btn-sm btn-outline-primary download-btn"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              title="{% if task.file_downloaded_of.count > 0 %}
                {% trans 'Heruntergeladen von' %}
                {% for user in task.file_downloaded_of.all %}
                  {{ user.first_name }} {{ user.last_name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                {% trans 'Noch nicht heruntergeladen' %}
              {% endif %}">
              <i class="bi bi-download"></i>
            </a>
          {% endif %}
          <button onclick="markTaskAsDone({{ task.id }})"
            class="btn btn-sm btn-outline-primary"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="{% trans 'Als erledigt markieren' %}">
            <i class="bi bi-check-circle-fill"></i>
          </button>
        {% elif task.user.customuser.mail_notifications %}
          {% if task.last_reminder == today %}
            <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Erinnerung heute bereits gesendet' %}">
              <button class="btn btn-sm btn-outline-primary" type="button" disabled style="pointer-events: none;">
                <i class="bi bi-bell-fill"></i>
              </button>
            </span>
          {% else %}
            <button id="sendTaskReminder{{ task.id }}"
              onclick="sendTaskReminder(this, {{ task.id }})"
              class="btn btn-sm btn-outline-primary"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              title="{% trans 'Erinnerung senden' %}{% if task.last_reminder %} ({% trans 'Zuletzt' %} {{ task.last_reminder|date:'d.m.' }}{% if task.last_reminder.year < today.year %}{{ task.last_reminder|date:'y' }}{% endif %}){% endif %}"
              data-sent-title="{% trans 'Erinnerung gesendet' %}">
              <i class="bi bi-bell-fill"></i>
            </button>
          {% endif %}
        {% endif %}

        <script>
          function markTaskAsDone(id) {
            fetch(`{% url 'mark_task_as_done' %}?id=${id}`, {
              method: 'GET',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              }
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  window.location.reload()
                } else {
                  alert(data.error)
                }
              })
          }

          function sendTaskReminder(button, id) {
            fetch(`{% url 'send_task_reminder' %}?id=${id}`, {
              method: 'GET',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              }
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  button.classList.add('btn-outline-success')
                  button.classList.remove('btn-outline-primary')
                  button.innerHTML = '<i class="bi bi-check-circle-fill"></i>'
                  $(button).attr('data-bs-original-title', button.dataset.sentTitle).tooltip('show')
                } else {
                  button.classList.add('btn-outline-danger')
                  button.classList.remove('btn-outline-primary')
                  button.innerHTML = '<i class="bi bi-x-circle-fill"></i>'
                  $(button).attr('data-bs-original-title', data.error).tooltip('show')
                }
              })
          }
        </script>

        <span class="badge badge-pill {% if not task.pending %}
            bg-danger
          {% elif task.pending %}
            bg-warning
          {% else %}
            bg-success
          {% endif %}">
          {{ task.faellig|date:'d.m.y'|default:'flexibel' }}
        </span>
      </div>
    </div>
  </div>
{% endfor %}
