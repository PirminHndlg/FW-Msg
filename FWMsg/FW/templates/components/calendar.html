{% load static %}
{% load i18n %}

<div class="card rounded-4 mb-2">
    <div class="card-header bg-light rounded-4 z-1">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{% url 'kalender' %}" class="text-decoration-none text-body">
                <h3 class="card-title mb-0">{% trans "Kalender" %}</h3>
            </a>
        </div>
    </div>
    <div class="card-body">
        <div id="calendar" class="calendar-container"></div>
    </div>
</div>

{% block calendar_scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    let calendarEvents = [];
    let touchStartX = 0;
    let touchEndX = 0;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function initializeCalendar() {
        try {
            const response = await fetch('{% url "get_calendar_events" %}');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            calendarEvents = await response.json();
            
            // Get language from Django cookie or default to 'de'
            const language = getCookie('django_language') || 'de';
            
            // Initialize calendar after events are loaded
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: '{{ initial_view|default:"dayGridMonth" }}',
                events: calendarEvents,
                height: 'auto',//{% if small_calendar %}100{% else %}'auto'{% endif %},
                locale: language,
                buttonText: {
                    today: '{% trans "Heute" %}'
                },
                headerToolbar: { 
                    left: 'prev,next',
                    center: 'title',
                    right: 'today'
                },
            });
            calendar.render();

            calendarEl.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            calendarEl.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, false);
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0) {
                        calendar.prev();
                    } else {
                        calendar.next();
                    }
                }
            }

        } catch (error) {
            console.error('Error loading calendar events:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', initializeCalendar);
</script>
{% endblock %} 