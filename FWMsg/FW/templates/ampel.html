{% extends extends_base|default:'baseFw.html' %}
{% load static %}
{% load i18n %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/ampel.css' %}">
{% endblock %}

{% block headline %}
    {% trans "Ampel" %}
{% endblock %}

{% block content %}
<form method="post" id="ampelForm">
    {% csrf_token %}
    {{ form.submission_key }}
    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
    <div class="card rounded-4 mb-4">
        <div class="card-header rounded-4">
            <h3 class="card-title mb-0">{% trans "Ampelmeldung" %}</h3>
        </div>
        <div class="card-body">
            <p class="text-center mb-3">{% trans "Bitte wähle eine Farbe aus, die deinen aktuellen Status am besten beschreibt" %}:</p>
            
            {# Traffic Light Selector Component #}
            {% include "components/ampel_selector.html" %}

            {# Comment Section #}
            <div class="mb-4">
                <h4 class="mb-3">{% trans "Anmerkungen" %}</h4>
                {{ form.comment }}
            </div>

            {# Footer with Status and Buttons #}
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch align-items-md-center gap-2">
                {# Last Status Component (compact on mobile) #}
                <div class="order-2 order-md-1 text-muted">
                    {% include "components/ampel_status.html" with last_ampel=last_ampel %}
                </div>

                {# Action Buttons: full-width on small, inline on md+ #}
                <div class="order-1 order-md-2 d-grid gap-2 d-flex flex-column-reverse flex-md-row">
                    <button type="button" class="btn btn-secondary w-100 w-md-auto me-0" onclick="window.location.href = '{% url 'fw_home' %}'">
                        <span class="d-flex align-items-center justify-content-center"><i class="bi bi-arrow-left me-2"></i>{% trans "Zurück" %}</span>
                    </button>
                    <button id="ampelSubmit" type="submit" class="btn btn-primary w-100 w-md-auto">
                        <span class="label d-flex align-items-center justify-content-center"><i class="bi bi-send me-2"></i>{% trans "Abschicken" %}</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    (function() {
        const form = document.getElementById('ampelForm');
        const btn = document.getElementById('ampelSubmit');
        window.submitted = false;

        // Generate a UUID v4 if template didn't provide one
        function genUUID() {
            if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
            // Fallback
            const s = [];
            const hex = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
            for (let i = 0; i < hex.length; i++) {
                const c = hex[i];
                if (c === 'x' || c === 'y') {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    s.push(v.toString(16));
                } else {
                    s.push(c);
                }
            }
            return s.join('');
        }

        let keyInput = document.getElementById('submission_key');
        if (!keyInput) {
            keyInput = document.querySelector('input[name="submission_key"]');
        }
        if (!keyInput.value) {
            keyInput.value = genUUID();
        }

        form.addEventListener('submit', (event) => {
            if (window.submitted) {
                event.preventDefault();
                return;
            }

            const selected = document.querySelector('input[name="{{ form.status.name }}"]:checked') || document.querySelector('input[name="{{ form.status.name }}"]');
            if (!selected || !selected.value) {
                event.preventDefault();
                // Show a visual error on the ampel container
                // dispay a error message
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.classList.remove('d-none');
                    errorMessage.classList.add('d-block');
                }
                const container = document.getElementById('ampel_container');
                if (container) {
                    container.classList.add('border', 'border-danger');
                }
                return;
            }

            // Lock UI
            window.submitted = true;
            btn.disabled = true;
            const label = btn.querySelector('.label');
            const spinner = btn.querySelector('.spinner-border');
            if (label) label.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');
            form.querySelectorAll('input, textarea, button, select').forEach(el => {
                if (el === btn) return;
                if (el.tagName === 'INPUT' && (el.type === 'hidden' || el.name === 'csrfmiddlewaretoken' || el.name === 'submission_key')) return;
                el.disabled = true;
            });
        });

        // Prevent accidental Enter submissions except in textarea
        form.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
        });
    })();
</script>
{% endblock %}