{% extends 'baseFw.html' %}
{% load static %}
{% load i18n %}
{% load base_filter %}

{% block head %}
{% endblock %}

{% block headline %}
    {% trans "FW Msg" %}
{% endblock %}

{% block content %}
    {# Counter until start date #}
    {% include "components/start_counter.html" %}

    {# Tasks Section #}
    {% if request.user.customuser.person_cluster.aufgaben %}
        <div class="card rounded-4 mb-2">
            <div class="card-header rounded-4">
                <a href="{% url 'aufgaben' %}" class="text-decoration-none text-body">
                    <h3 class="mb-0">{% trans "Aufgaben" %} ‚ü©</h3>
                </a>
            </div>
            <div class="card-body">
                {% include "components/task_progress.html" with aufgaben=aufgaben %}
                
                {% if aufgaben.offen %}
                {% include "components/task_grid.html" with tasks=aufgaben.offen %}
                {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle me-2"></i>{% trans "Alle Aufgaben sind erledigt!" %}
                    </div>
                {% endif %}

                <div class="text-center mt-3">
                    <a href="{% url 'aufgaben' %}" class="btn btn-secondary btn-sm text-white">
                        {% trans "Alle Aufgaben anzeigen" %}
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

    {# Unified Feed: Posts and Images #}
    {% if feed %}
    <div class="card rounded-4 mb-2">
        <div class="card-header rounded-4 d-flex justify-content-between align-items-center">
            <h3 class="mb-0">{% trans "Neuigkeiten" %}</h3>
            <div class="d-flex gap-2">
                <a href="{% url 'posts_overview' %}" class="btn btn-outline-secondary btn-sm">{% trans "Alle Posts" %}</a>
                <a href="{% url 'bilder' %}" class="btn btn-outline-secondary btn-sm">{% trans "Alle Bilder" %}</a>
            </div>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-xxl-3 g-4">
                {% if last_ampel and last_ampel.read %}
                <!-- Beautiful card showing that the last ampel was read -->
                <div class="col">
                    <div class="card rounded-4 h-100 border-success border-2" style="background: linear-gradient(135deg, #d4edda 0%, #f1f9f4 100%);">
                        <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-4">
                            <div class="mb-3">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="card-title text-success fw-bold mb-2">
                                {% trans "Ampelmeldung gelesen" %}
                            </h5>
                            <p class="card-text text-muted mb-3">
                                {% trans "Deine letzte Ampelmeldung wurde gelesen" %}
                            </p>
                            <div class="d-flex align-items-center gap-2 text-muted small">
                                <i class="bi bi-clock"></i>
                                <span>{{ last_ampel.date|date:"d.m.Y H:i" }}</span>
                            </div>
                            {% if last_ampel.comment %}
                            <div class="mt-3 p-2 bg-white rounded-3 w-100 text-start">
                                <small class="text-muted">
                                    <i class="bi bi-chat-left-quote me-1"></i>
                                    {{ last_ampel.comment|truncatewords:15 }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% for item in feed %}
                    {% if item.type == 'post' %}
                    <div class="col">
                        {% include "components/post_card_object.html" with post=item.post %}
                    </div>
                    {% elif item.type == 'image' %}
                        <div class="col">
                            <div class="card rounded-4 h-100">
                                <div class="card-header">
                                    {% with bild=item.bild bilder_gallery=item.bild.bildergallery2_set.all %}
                                        {% include 'components/image_card_header.html' %}
                                    {% endwith %}
                                </div>
                                <div class="card-body p-0">
                                    {% with bild=item.bild bilder_gallery=item.bild.bildergallery2_set.all %}
                                        {% include 'components/image_carousel.html' %}
                                        {% include 'components/image_description.html' %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}