{% extends extends_base|default:'baseFw.html' %}
{% load static %}
{% load dokument_filter %}
{% load i18n %}

{% block head %}
  <script src="{% static 'js/dokumente.js' %}"></script>
  <script>
    let is_org = {% if user.role == 'O' %}true{% else %}false{% endif %}
    let ordner_id = '{{ ordner_id }}'
    
    document.addEventListener('DOMContentLoaded', function () {
      const accordionCollapses = document.querySelectorAll('.accordion-collapse')
    
      function handleCollapseShow(collapse) {
        // Extract folder ID and get spinner/icon elements
        const id = collapse.id.split('collapse')[1]
        const folderIcon = document.getElementById('folderIcon' + id)
        const folderSpinner = document.getElementById('folderSpinner' + id)
        
        // Show spinner and hide icon at start
        if (folderIcon && folderSpinner) {
          folderIcon.classList.add('d-none')
          folderSpinner.classList.remove('d-none')
        }
        
        // Get all elements that need to load
        const elementsToLoad = collapse.querySelectorAll('[data-preview-src]')
        let loadedCount = 0
        const totalElements = elementsToLoad.length
        
        // If no elements to load, show icon immediately
        if (totalElements === 0) {
          if (folderIcon && folderSpinner) {
            folderSpinner.classList.add('d-none')
            folderIcon.classList.remove('d-none')
          }
          return
        }
        
        // Function to check if all elements are loaded
        function checkAllLoaded() {
          loadedCount++
          if (loadedCount >= totalElements) {
            // All elements loaded, show icon and hide spinner
            if (folderIcon && folderSpinner) {
              folderSpinner.classList.add('d-none')
              folderIcon.classList.remove('d-none')
            }
          }
        }
        
        // Process each element
        elementsToLoad.forEach((element) => {
          // Skip if already loaded
          if (element.tagName === 'SOURCE') {
            const currentSrc = element.getAttribute('src')
            if (currentSrc && currentSrc !== '') {
              // Already loaded
              checkAllLoaded()
              return
            }
          } else if (element.src) {
            // Already loaded
            checkAllLoaded()
            return
          }

          if (element.tagName === 'SOURCE') {
            // Handle source elements for video
            const currentSrc = element.getAttribute('src')
            if (!currentSrc || currentSrc === '') {
              element.setAttribute('src', element.dataset.previewSrc)
              // reload the video by calling load() on the parent video element
              const videoElement = element.closest('video')
              if (videoElement) {
                // Wait for video to load metadata
                videoElement.addEventListener('loadedmetadata', checkAllLoaded, { once: true })
                videoElement.addEventListener('error', checkAllLoaded, { once: true })
                videoElement.load()
              } else {
                // No video element found, count as loaded
                checkAllLoaded()
              }
            }
          } else {
            // Handle other elements (img, etc.)
            if (!element.src) {
              element.src = element.dataset.previewSrc
              // Wait for image to load
              element.addEventListener('load', checkAllLoaded, { once: true })
              element.addEventListener('error', checkAllLoaded, { once: true })
            } else {
              checkAllLoaded()
            }
          }
        })
      }
    
      accordionCollapses.forEach((collapse) => {
        collapse.addEventListener('show.bs.collapse', function () {
          handleCollapseShow(this)
        })
      })
    
      if (ordner_id) {
        const element = document.getElementById('folderAccordion').querySelector(`[data-bs-target="#collapse${ordner_id}"]`)
        if (element) {
          element.click()
          setTimeout(() => {
            const cardBody = element.closest('.card').querySelector('.card-body')
            cardBody.scrollIntoView({ behavior: 'smooth', block: 'start' })
          }, 350)
        }
      }
    })
  </script>
{% endblock %}

{% block headline %}
  {% trans 'Dokumente' %}
{% endblock %}

{% block content %}
  {% csrf_token %}
  {% if error %}
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      {{ error }}
    </div>
  {% else %}
    <div class="card rounded-4 mb-3">
      <div class="card-header rounded-4">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="mb-0">{% trans 'Dokumente' %}</h3>

          {% if user.role == 'O' %}
            <button class="btn btn-sm btn-primary rounded-4" onclick="addOrdner()"><i class="bi bi-folder-plus me-2"></i> {% trans 'Neuer Ordner' %}</button>
          {% endif %}
        </div>

        {% if user.role == 'O' %}
          <div class="d-flex gap-1 justify-content-center align-items-center mt-2">
            <strong>{% trans "Benutzergruppe" %}</strong>
              <div class="gap-1 flex-wrap justify-content-center align-items-center d-none d-md-flex">
                <a class="btn btn-sm rounded-4 btn-outline-primary {% if not current_person_cluster %}active{% endif %}" href="{% url 'dokumente' %}?person_cluster_filter=None">
                  {% trans 'Alle' %}
                </a>
              {% for person_cluster in person_clusters %}
                  <a class="btn btn-sm rounded-4 btn-outline-primary {% if current_person_cluster == person_cluster %}active{% endif %}" href="{% url 'dokumente' %}?person_cluster_filter={{ person_cluster.id }}">
                    {{ person_cluster.name }}
                  </a>
                {% endfor %}
              </div>
              <div class="d-flex gap-1 flex-wrap justify-content-center align-items-center d-md-none">
                <select class="form-select form-select-sm rounded-4" onchange="window.location.href = this.value;">
                  <option value="{% url 'dokumente' %}?person_cluster_filter=None">{% trans 'Alle' %}</option>
                  {% for person_cluster in person_clusters %}
                    <option value="{% url 'dokumente' %}?person_cluster_filter={{ person_cluster.id }}" {% if current_person_cluster == person_cluster %}selected{% endif %}>
                      {{ person_cluster.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
          </div>
        {% endif %}
      </div>

      {% comment %} <div class="card-body">
      <div class="alert alert-info rounded-4 mb-3" role="alert">
        <div class="d-flex align-items-center">
          <i class="bi bi-info-circle-fill me-2"></i>
          <div>
            <strong>{% trans 'Hinweis:' %}</strong> {% trans 'Einige Dokumente wurden während des Updates gelöscht und werden so bald wie möglich wiederhergestellt.' %}
          </div>
        </div>
      </div>
      </div> {% endcomment %}
      
    </div>

    <div class="accordion mb-3" id="folderAccordion">
      {% for structure in folder_structure %}
        {% include 'components/folder_card.html' %}
      {% endfor %}
    </div>
  {% endif %}

  {% include 'components/document_modal.html' %}
  {% include 'components/folder_modal.html' %}
{% endblock %}
