{% extends base_template|default:'base.html' %}
{% load i18n %}
{% load base_filter %}

{% block title %}
  {% trans 'Einsatzstellen' %}| {{ user.org.name }}
{% endblock %}

{% block head %}
<style>
  details summary {
    cursor: pointer;
    user-select: none;
  }
  details summary::-webkit-details-marker {
    display: none;
  }
  details summary::marker {
    display: none;
  }
  details summary::before {
    content: '▶';
    display: inline-block;
    margin-right: 0.5rem;
    transition: transform 0.2s;
  }
  details[open] summary::before {
    transform: rotate(90deg);
  }
</style>
{% endblock %}

{% block content %}
  <h2 class="mb-4">{% trans 'Einsatzstellen' %}</h2>

  {% if einsatzstellen %}
    <!-- Get unique countries -->
    {% regroup einsatzstellen by land as laender_list %}
    
    <!-- Filter Section - Only show if multiple countries -->
    {% if laender_list|length > 1 %}
      <div class="mb-4">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="fw-medium text-muted">
            <i class="bi bi-funnel me-1"></i>{% trans 'Filtern nach Land:' %}
          </span>
          <div class="btn-group" role="group" aria-label="{% trans 'Land Filter' %}">
            <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all">
              {% trans 'Alle' %} <span class="badge bg-primary ms-1">{{ einsatzstellen|length }}</span>
            </button>
            {% for land_group in laender_list %}
              {% if land_group.grouper %}
                <button type="button" class="btn btn-sm btn-outline-primary" data-filter="{{ land_group.grouper.id }}">
                  {{ land_group.grouper.name }} <span class="badge bg-primary ms-1">{{ land_group.list|length }}</span>
                </button>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
    <div class="row row-cols-1 row-cols-lg-2 g-4" id="einsatzstellen-grid">
      {% for stelle in einsatzstellen %}
        <div class="col einsatzstelle-item" data-land-id="{{ stelle.land.id|default:'none' }}">
          <div class="card h-100 border-0 rounded-4 shadow-sm position-relative {% if stelle.id in pending_requests_by_stelle %}border-warning border-3{% endif %}" data-placement-id="{{ stelle.id }}">
            
            <!-- Edit Button -->
            <button class="btn btn-sm btn-light rounded-circle shadow-sm position-absolute top-0 end-0 m-3 z-3" 
                    data-bs-toggle="modal" data-bs-target="#editModal-{{ stelle.id }}" 
                    title="{% trans 'Bearbeiten' %}">
              <i class="bi bi-pencil"></i>
            </button>

            <!-- Placement Header -->
            <div class="card-header bg-primary text-white border-0 rounded-top-4 p-3">
              <h5 class="card-title mb-0 fw-bold">{{ stelle.name }}</h5>
              {% if stelle.land %}
                <div class="badge bg-light text-dark mt-2 fw-normal">
                  <i class="bi bi-geo-alt-fill me-1"></i>{{ stelle.land.name }}
                </div>
              {% endif %}
            </div>

            <!-- Placement Information -->
            <div class="card-body p-4">
              <!-- Pending Change Request Info -->
              {% if stelle.id in pending_requests_by_stelle %}
                {% with request=pending_requests_by_stelle|get_item:stelle.id %}
                <div class="alert alert-warning border-0 mb-4">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-clock-fill me-2"></i>
                    <strong>{% trans 'Änderungsvorschlag ausstehend' %}</strong>
                  </div>
                  <small class="text-muted d-block mb-2">
                    {% trans 'Eingereicht am' %} {{ request.created_at|date:"d.m.Y H:i" }}
                  </small>
                  {% if request.reason %}
                    <p class="mb-2 small"><strong>{% trans 'Begründung:' %}</strong> {{ request.reason }}</p>
                  {% endif %}
                  <details class="small">
                    <summary class="cursor-pointer text-primary fw-medium">{% trans 'Vorgeschlagene Änderungen anzeigen' %}</summary>
                    <div class="mt-2">
                      {% for change in request.get_field_changes_display %}
                        <div class="mb-2 ps-3 border-start border-primary border-2">
                          <strong class="d-block text-primary">{{ change.field }}</strong>
                          <div class="text-muted">{% trans 'Von:' %} <em>{{ change.current|default:"Leer"|truncatewords:10 }}</em></div>
                          <div class="text-muted">{% trans 'Zu:' %} <em>{{ change.new|default:"Leer"|truncatewords:10 }}</em></div>
                        </div>
                      {% endfor %}
                    </div>
                  </details>
                </div>
                {% endwith %}
              {% endif %}
              
              <!-- Partner Organization Section -->
              <div class="mb-4">
                <h5 class="border-bottom pb-2 mb-3 d-flex align-items-center text-primary">
                  <i class="bi bi-building me-2"></i> {% trans 'Partnerorganisation' %}
                </h5>
                <div class="info-content">
                  {% if stelle.partnerorganisation %}
                    <div class="small">{{ stelle.partnerorganisation|linebreaks }}</div>
                  {% else %}
                    <div class="text-muted small">
                      <i class="bi bi-exclamation-circle me-1"></i>{% trans 'Keine Partnerorganisation hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Supervisor Section -->
              <div class="mb-4">
                <h5 class="border-bottom pb-2 mb-3 d-flex align-items-center text-primary">
                  <i class="bi bi-person-badge me-2"></i> {% trans 'Arbeitsvorgesetzte:r' %}
                </h5>
                <div class="info-content">
                  {% if stelle.arbeitsvorgesetzter %}
                    <div class="small">{{ stelle.arbeitsvorgesetzter|linebreaks }}</div>
                  {% else %}
                    <div class="text-muted small">
                      <i class="bi bi-exclamation-circle me-1"></i>{% trans 'Keine Arbeitsvorgesetzte:r hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Mentor Section -->
              <div class="mb-4">
                <h5 class="border-bottom pb-2 mb-3 d-flex align-items-center text-primary">
                  <i class="bi bi-person-check me-2"></i> {% trans 'Mentor:in' %}
                </h5>
                <div class="info-content">
                  {% if stelle.mentor %}
                    <div class="small">{{ stelle.mentor|linebreaks }}</div>
                  {% else %}
                    <div class="text-muted small">
                      <i class="bi bi-exclamation-circle me-1"></i>{% trans 'Keine Mentor:in hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Embassy Section -->
              <div class="mb-4">
                <h5 class="border-bottom pb-2 mb-3 d-flex align-items-center text-primary">
                  <i class="bi bi-bank me-2"></i> {% trans 'Botschaft' %}
                </h5>
                <div class="info-content">
                  {% if stelle.botschaft %}
                    <div class="small">{{ stelle.botschaft|linebreaks }}</div>
                  {% else %}
                    <div class="text-muted small">
                      <i class="bi bi-exclamation-circle me-1"></i>{% trans 'Keine Botschaftsinformationen hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Consulate Section -->
              <div class="mb-4">
                <h5 class="border-bottom pb-2 mb-3 d-flex align-items-center text-primary">
                  <i class="bi bi-building-fill me-2"></i> {% trans 'Konsulat' %}
                </h5>
                <div class="info-content">
                  {% if stelle.konsulat %}
                    <div class="small">{{ stelle.konsulat|linebreaks }}</div>
                  {% else %}
                    <div class="text-muted small">
                      <i class="bi bi-exclamation-circle me-1"></i>{% trans 'Keine Konsulatsinformationen hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Additional Information Section -->
              <div class="mb-0">
                <h5 class="border-bottom pb-2 mb-3 d-flex align-items-center text-primary">
                  <i class="bi bi-info-circle me-2"></i> {% trans 'Weitere Informationen' %}
                </h5>
                <div class="info-content">
                  {% if stelle.informationen %}
                    <div class="small">{{ stelle.informationen|linebreaks }}</div>
                  {% else %}
                    <div class="text-muted small">
                      <i class="bi bi-exclamation-circle me-1"></i>{% trans 'Keine weiteren Informationen hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Modal -->
          <div class="modal fade" id="editModal-{{ stelle.id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ stelle.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content rounded-4 border-0">
                <div class="modal-header bg-primary text-white border-0">
                  <h5 class="modal-title" id="editModalLabel-{{ stelle.id }}">
                    <i class="bi bi-pencil-square me-2"></i>{% trans 'Informationen bearbeiten' %}: {{ stelle.name }}
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                  <form method="post" action="{% url 'save_einsatzstelle_info' stelle.id %}">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                      <label for="partnerorganisation-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-building me-2 text-primary"></i> {% trans 'Partnerorganisation' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="4" id="partnerorganisation-{{ stelle.id }}" name="partnerorganisation" placeholder="{% trans 'Partnerorganisation hier eingeben...' %}">{{ stelle.partnerorganisation|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="arbeitsvorgesetzter-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-person-badge me-2 text-primary"></i> {% trans 'Arbeitsvorgesetzte:r' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="4" id="arbeitsvorgesetzter-{{ stelle.id }}" name="arbeitsvorgesetzter" placeholder="{% trans 'Arbeitsvorgesetzte:r hier eingeben...' %}">{{ stelle.arbeitsvorgesetzter|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="mentor-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-person-check me-2 text-primary"></i> {% trans 'Mentor:in' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="4" id="mentor-{{ stelle.id }}" name="mentor" placeholder="{% trans 'Mentor:in hier eingeben...' %}">{{ stelle.mentor|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="botschaft-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-bank me-2 text-primary"></i> {% trans 'Botschaft' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="4" id="botschaft-{{ stelle.id }}" name="botschaft" placeholder="{% trans 'Botschaftsinformationen hier eingeben...' %}">{{ stelle.botschaft|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="konsulat-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-building-fill me-2 text-primary"></i> {% trans 'Konsulat' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="4" id="konsulat-{{ stelle.id }}" name="konsulat" placeholder="{% trans 'Konsulatsinformationen hier eingeben...' %}">{{ stelle.konsulat|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="informationen-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-info-circle me-2 text-primary"></i> {% trans 'Weitere Informationen' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="4" id="informationen-{{ stelle.id }}" name="informationen" placeholder="{% trans 'Weitere Informationen hier eingeben...' %}">{{ stelle.informationen|default:'' }}</textarea>
                    </div>

                    <div class="mb-4">
                      <label for="reason-{{ stelle.id }}" class="form-label fw-medium d-flex align-items-center">
                        <i class="bi bi-chat-text me-2 text-warning"></i> {% trans 'Begründung für Änderung' %}
                      </label>
                      <textarea class="form-control rounded-3" rows="3" id="reason-{{ stelle.id }}" name="reason" placeholder="{% trans 'Warum diese Änderungen? Was ist neu? Was ist anders?' %}" required></textarea>
                      <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>
                        {% trans 'Deine Änderungen wird zur Prüfung an die Organisation gesendet.' %}
                      </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>{% trans 'Abbrechen' %}
                      </button>
                      <button type="submit" class="btn btn-warning rounded-3">
                        <i class="bi bi-send me-2"></i>{% trans 'Änderung vorschlagen' %}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info rounded-3">
      <i class="bi bi-info-circle me-2"></i>
      {% trans 'Keine Einsatzstellen gefunden. Bitte wenden Sie sich an den Administrator.' %}
    </div>
  {% endif %}

  <!-- Filter JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get all filter buttons
      const filterButtons = document.querySelectorAll('[data-filter]');
      
      if (filterButtons.length > 0) {
        filterButtons.forEach(button => {
          button.addEventListener('click', function() {
            // Get filter value
            const filterValue = this.getAttribute('data-filter');
            
            // Update active state
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Get all einsatzstelle items
            const items = document.querySelectorAll('.einsatzstelle-item');
            
            // Filter items
            items.forEach(item => {
              const landId = item.getAttribute('data-land-id');
              
              if (filterValue === 'all') {
                // Show all items
                item.style.display = '';
                item.classList.add('fade-in');
              } else if (landId === filterValue) {
                // Show matching items
                item.style.display = '';
                item.classList.add('fade-in');
              } else {
                // Hide non-matching items
                item.style.display = 'none';
                item.classList.remove('fade-in');
              }
            });
          });
        });
      }
    });
  </script>

  <style>
    .einsatzstelle-item {
      transition: opacity 0.3s ease;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
{% endblock %}

