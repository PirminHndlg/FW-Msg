{% extends extends_base|default:'baseFw.html' %}
{% load i18n %}
{% load static %}

{% block head %}
  <style>
    .device-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .device-card {
      transition: all 0.2s ease;
    }
    
    .device-card:hover {
      box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
    }
    
    .badge-device {
      background-color: rgba(var(--bs-primary-rgb), 0.1);
      color: var(--bs-primary);
    }
    
    .push-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    
    .push-status-indicator.enabled {
      background-color: var(--bs-success);
    }
    
    .push-status-indicator.disabled {
      background-color: var(--bs-danger);
    }
  </style>
{% endblock %}

{% block title %}
  Push-Benachrichtigungen
{% endblock %}

{% block content %}
  <div class="card rounded-4 mb-3">
    <div class="card-header rounded-4">
      <h3 class="mb-0">{% trans 'Push-Benachrichtigungen' %}</h3>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card rounded-4 mb-3">
        <div class="card-body">
          <p class="card-text text-muted">
            {% trans 'Durch Push-Benachrichtigungen erhältst du sofortige Aufgabenbenachrichtigungen, auch wenn du die Website nicht geöffnet hast.' %}
          </p>

          <div id="pushStatus" class="alert alert-info d-flex align-items-center mb-4">
            <div class="push-status-indicator disabled me-2" id="pushStatusIndicator"></div>
            <div id="pushStatusText">
              {% trans 'Prüfe Push-Benachrichtigungen Status...' %}
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-center mb-4">
            <button class="btn btn-primary" id="enablePushBtn" type="button"><i class="bi bi-bell-fill me-2"></i>{% trans 'Push-Benachrichtigungen aktivieren' %}</button>

            <form method="post" class="d-inline">
              {% csrf_token %}
              <button type="submit" name="send_test" value="1" class="btn btn-outline-secondary"><i class="bi bi-send me-2"></i>{% trans 'Test-Benachrichtigung senden' %}</button>
            </form>
          </div>

          <div class="alert alert-light border">
            <h6>{% trans 'Hinweise' %}:</h6>
            <ul class="mb-0">
              <li>
                {% trans 'Push-Benachrichtigungen funktionieren nur in modernen Browsern.' %}
              </li>
              <li>
                {% trans 'Du musst Push-Benachrichtigungen für jedes Gerät und jeden Browser separat aktivieren.' %}
              </li>
              <li>
                {% trans 'Du kannst Push-Benachrichtigungen jederzeit in den Browser-Einstellungen deaktivieren.' %}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Mobile Tutorial Section -->
      <div class="card rounded-4 mb-3">
        <div class="card-header rounded-4">
          <h5 class="mb-0">
            <i class="bi bi-phone me-2"></i>
            {% trans 'Anleitung für mobile Geräte' %}
          </h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <h6 class="fw-bold mb-2">
              <i class="bi bi-info-circle me-2"></i>
              {% trans 'So aktivierst du Push-Benachrichtigungen für dein Smartphone oder Tablet:' %}
            </h6>
            <ol class="mb-0">
              <li>{% trans 'Melde dich ab' %} <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-secondary ms-2"><i class="bi bi-box-arrow-in-right"></i> {% trans 'Logout' %}</a></li>
              <li>{% trans 'Bleib auf der Startseite (/), um die Web-App zu installieren' %}</li>
              <li>{% trans 'Installiere die Website als Web-App ("Zum Startbildschirm hinzufügen" oder "App installieren")' %}</li>
              <li>{% trans 'Melde dich in der installierten Web-App an' %}</li>
              <li>{% trans 'Aktiviere die Push-Benachrichtigungen in der Web-App' %}</li>
            </ol>
          </div>
          <p class="text-muted">
            <strong>{% trans 'Wichtig:' %}</strong>
            {% trans 'Die Installation muss von der Startseite (/) aus erfolgen, nicht von dieser Unterseite.' %}
          </p>

          <!-- Accordion for different platforms -->
          <div class="accordion mb-3" id="mobileTutorialAccordion">
            
            <!-- Android / Chrome Tutorial -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingAndroid">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAndroid" aria-expanded="false" aria-controls="collapseAndroid">
                  <i class="bi bi-android2 me-2 text-success"></i>
                  {% trans 'Android (Chrome/Firefox)' %}
                </button>
              </h2>
              <div id="collapseAndroid" class="accordion-collapse collapse" aria-labelledby="headingAndroid" data-bs-parent="#mobileTutorialAccordion">
                <div class="accordion-body">
                  <h6 class="fw-bold">{% trans 'Schritt 1: Website als App installieren' %}</h6>
                  <ol class="mb-3">
                    <li>
                      {% trans 'Öffne die Website in Chrome oder Firefox' %}
                    </li>
                    <li>
                      {% trans 'Tippe auf das Menü-Symbol (drei Punkte) oben rechts' %}
                    </li>
                    <li>
                      {% trans 'Wähle "Zum Startbildschirm hinzufügen" oder "App installieren"' %}
                    </li>
                    <li>
                      {% trans 'Bestätige mit "Hinzufügen" oder "Installieren"' %}
                    </li>
                    <li>
                      {% trans 'Die Web-App erscheint nun auf deinem Startbildschirm' %}
                    </li>
                  </ol>

                  <h6 class="fw-bold">{% trans 'Schritt 2: Push-Benachrichtigungen aktivieren' %}</h6>
                  <ol class="mb-3">
                    <li>
                      {% trans 'Öffne die installierte Web-App vom Startbildschirm' %}
                    </li>
                    <li>
                      {% trans 'Navigiere zu dieser Push-Einstellungen-Seite' %}
                    </li>
                    <li>
                      {% trans 'Klicke oben auf "Push-Benachrichtigungen aktivieren"' %}
                    </li>
                    <li>
                      {% trans 'Erlaube Benachrichtigungen, wenn der Browser fragt' %}
                    </li>
                  </ol>

                  <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>{% trans 'Wichtig' %}:</strong> 
                    {% trans 'Push-Benachrichtigungen funktionieren nur, wenn die Web-App über den Startbildschirm installiert wurde. Der normale Browser unterstützt keine Push-Benachrichtigungen auf Android.' %}
                  </div>
                </div>
              </div>
            </div>

            <!-- iOS / Safari Tutorial -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingIOS">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIOS" aria-expanded="false" aria-controls="collapseIOS">
                  <i class="bi bi-apple me-2"></i>
                  {% trans 'iOS / iPadOS (Safari)' %}
                </button>
              </h2>
              <div id="collapseIOS" class="accordion-collapse collapse" aria-labelledby="headingIOS" data-bs-parent="#mobileTutorialAccordion">
                <div class="accordion-body">
                  <h6 class="fw-bold">{% trans 'Schritt 1: Website zum Home-Bildschirm hinzufügen' %}</h6>
                  <ol class="mb-3">
                    <li>
                      {% trans 'Öffne die Website in Safari' %}
                      <small class="text-muted d-block">
                        {% trans '(Andere Browser wie Chrome oder Firefox unterstützen keine Web-Apps auf iOS)' %}
                      </small>
                    </li>
                    <li>
                      {% trans 'Tippe auf das Teilen-Symbol' %}
                      <i class="bi bi-box-arrow-up"></i>
                      {% trans 'unten in der Mitte' %}
                    </li>
                    <li>
                      {% trans 'Scrolle nach unten und wähle "Zum Home-Bildschirm"' %}
                    </li>
                    <li>
                      {% trans 'Gib einen Namen ein (optional) und tippe auf "Hinzufügen"' %}
                    </li>
                    <li>
                      {% trans 'Die Web-App erscheint nun auf deinem Home-Bildschirm' %}
                    </li>
                  </ol>

                  <h6 class="fw-bold">{% trans 'Schritt 2: Push-Benachrichtigungen aktivieren' %}</h6>
                  <ol class="mb-3">
                    <li>
                      {% trans 'Öffne die installierte Web-App vom Home-Bildschirm' %}
                    </li>
                    <li>
                      {% trans 'Navigiere zu dieser Push-Einstellungen-Seite' %}
                    </li>
                    <li>
                      {% trans 'Klicke auf "Push-Benachrichtigungen aktivieren"' %}
                    </li>
                    <li>
                      {% trans 'Erlaube Benachrichtigungen, wenn Safari fragt' %}
                    </li>
                  </ol>

                  <h6 class="fw-bold">{% trans 'Schritt 3: Benachrichtigungen in iOS-Einstellungen erlauben (falls nötig)' %}</h6>
                  <ol class="mb-3">
                    <li>
                      {% trans 'Öffne die iOS "Einstellungen"-App' %}
                    </li>
                    <li>
                      {% trans 'Gehe zu "Mitteilungen"' %}
                    </li>
                    <li>
                      {% trans 'Suche die installierte Web-App in der Liste' %}
                    </li>
                    <li>
                      {% trans 'Aktiviere "Mitteilungen erlauben"' %}
                    </li>
                    <li>
                      {% trans 'Wähle deine bevorzugten Benachrichtigungsoptionen (Banner, Töne, etc.)' %}
                    </li>
                  </ol>

                  <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>{% trans 'Hinweis für iOS' %}:</strong> 
                    {% trans 'Push-Benachrichtigungen auf iOS funktionieren nur mit Safari und erfordern iOS 16.4 oder neuer. Die App muss über "Zum Home-Bildschirm" installiert werden.' %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion" id="troubleshootingAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTroubleshooting">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTroubleshooting" aria-expanded="false" aria-controls="collapseTroubleshooting">
                  <i class="bi bi-tools me-2 text-warning"></i>
                  {% trans 'Problembehandlung' %}
                </button>
              </h2>
              <div id="collapseTroubleshooting" class="accordion-collapse collapse" aria-labelledby="headingTroubleshooting" data-bs-parent="#troubleshootingAccordion">
                <div class="accordion-body">
                  <h6 class="fw-bold">{% trans 'Push-Benachrichtigungen funktionieren nicht?' %}</h6>
                  
                  <div class="mb-3">
                    <strong>{% trans 'Prüfe Folgendes' %}:</strong>
                    <ul class="mt-2">
                      <li>
                        {% trans 'Hast du die Website als Web-App installiert? (Nicht nur als Lesezeichen!)' %}
                      </li>
                      <li>
                        {% trans 'Öffnest du die Website über die Web-App auf dem Startbildschirm?' %}
                      </li>
                      <li>
                        {% trans 'Sind Benachrichtigungen in den System-Einstellungen erlaubt?' %}
                      </li>
                      <li>
                        {% trans 'Hast du Push-Benachrichtigungen auf dieser Seite aktiviert?' %}
                      </li>
                    </ul>
                  </div>

                  <div class="mb-3">
                    <strong>{% trans 'Falls es immer noch nicht funktioniert' %}:</strong>
                    <ol class="mt-2">
                      <li>
                        {% trans 'Entferne die Web-App vom Startbildschirm' %}
                      </li>
                      <li>
                        {% trans 'Lösche den Browser-Cache und alle Website-Daten' %}
                      </li>
                      <li>
                        {% trans 'Installiere die Web-App erneut (Startseite (/))' %}
                      </li>
                      <li>
                        {% trans 'Aktiviere Push-Benachrichtigungen erneut' %}
                      </li>
                    </ol>
                  </div>

                  <div class="alert alert-secondary mb-0">
                    <i class="bi bi-question-circle me-2"></i>
                    {% trans 'Benötigst du weitere Hilfe? Kontaktiere den Support oder die Administratoren.' %}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card rounded-4">
        <div class="card-header rounded-4">
          <h5 class="card-title mb-0">{% trans 'Registrierte Geräte' %}</h5>
        </div>
        <div class="card-body p-3">
          <div class="device-list">
            {% if subscriptions %}
              <ul class="list-group list-group-flush">
                {% for subscription in subscriptions %}
                  <li class="list-group-item device-card">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-laptop me-2 text-muted"></i>
                          <span>{{ subscription.name|default:'Unbenanntes Gerät' }}</span>
                        </div>
                        <small class="text-muted d-block">
                          {% if subscription.last_used %}
                            {{ subscription.last_used|date:'d.m.Y H:i' }}
                          {% else %}
                            {% trans 'Noch nicht verwendet' %}
                          {% endif %}
                        </small>
                      </div>
                      <a href="{% url 'remove_subscription' subscription.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('{% trans 'Bist du sicher, dass du dieses Gerät entfernen möchtest?' %}')"><i class="bi bi-trash"></i></a>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-center py-4">
                <i class="bi bi-bell-slash fs-2 text-muted"></i>
                <p class="mt-2 text-muted">
                  {% trans 'Keine Geräte registriert' %}
                </p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% csrf_token %}

  <script src="{% static 'js/push-notifications.js' %}"></script>
  <script>
    // Update UI based on push notification status
    async function updatePushUI() {
      const statusIndicator = document.getElementById('pushStatusIndicator')
      const statusText = document.getElementById('pushStatusText')
      const statusContainer = document.getElementById('pushStatus')
      const enableBtn = document.getElementById('enablePushBtn')
    
      if (!isPushNotificationSupported()) {
        statusIndicator.className = 'push-status-indicator disabled'
        statusText.textContent = '{% trans "Push-Benachrichtigungen werden von deinem Browser nicht unterstützt." %}'
        statusContainer.className = 'alert alert-warning d-flex align-items-center mb-4'
        enableBtn.disabled = true
        return
      }
    
      const subscription = await checkPushSubscription()
    
      if (subscription) {
        statusIndicator.className = 'push-status-indicator enabled'
        statusText.textContent = '{% trans "Push-Benachrichtigungen sind aktiviert." %}'
        statusContainer.className = 'alert alert-success d-flex align-items-center mb-4'
        enableBtn.textContent = '{% trans "Push-Benachrichtigungen erneuern" %}'
      } else {
        const permission = Notification.permission
    
        if (permission === 'denied') {
          statusIndicator.className = 'push-status-indicator disabled'
          statusText.innerHTML = '{% trans "Push-Benachrichtigungen sind blockiert. Bitte erlaube die Benachrichtigungen in deinen" %} <a href="https://support.google.com/chrome/answer/3220216" target="_blank">{% trans "Browser-Einstellungen" %}</a>.'
          statusContainer.className = 'alert alert-danger d-flex align-items-center mb-4'
        } else {
          statusIndicator.className = 'push-status-indicator disabled'
          statusText.textContent = '{% trans "Push-Benachrichtigungen sind nicht aktiviert." %}'
          statusContainer.className = 'alert alert-info d-flex align-items-center mb-4'
        }
      }
    }
    
    // Setup event listeners when the page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Update the UI
      updatePushUI()
    
      // Handle enable push button click
      document.getElementById('enablePushBtn').addEventListener('click', async function () {
        const publicKey = '{{ vapid_public_key }}'
        const result = await subscribeToPushNotifications(publicKey)
    
        if (result.success) {
          // Show success message and update UI
          const statusContainer = document.getElementById('pushStatus')
          statusContainer.className = 'alert alert-success d-flex align-items-center mb-4'
          document.getElementById('pushStatusIndicator').className = 'push-status-indicator enabled'
          document.getElementById('pushStatusText').textContent = result.message
    
          // Reload the page after a short delay to show the new device
          setTimeout(() => {
            window.location.reload()
          }, 3000)
        } else {
          // Show error message
          const statusContainer = document.getElementById('pushStatus')
          statusContainer.className = 'alert alert-danger d-flex align-items-center mb-4'
          document.getElementById('pushStatusText').textContent = result.message
        }
      })
    })
    
    // Front-end **Service Worker** listening for events
    document.addEventListener('push', (event) => {
      const data = event.data.json() // Payload from the server, assumed to be in JSON format
    
      event.waitUntil(
        // Upon receiving the push event, call **Notifications API** to push the notification
        self.registration.showNotification(data.title ? data.title : 'New Message', {
          body: data.body,
          badge: 'images/badge_icon.png',
          vibrate: [200, 100, 200],
          timestamp: Date.now(),
          data: { use_to_open_specific_page: data.props } // Custom data sent from the server
        })
      )
    })
  </script>
{% endblock %}

{% block scripts %}

{% endblock %}
