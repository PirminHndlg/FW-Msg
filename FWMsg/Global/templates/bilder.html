{% extends extends_base|default:'baseFw.html' %}
{% load static %}
{% load i18n %}

{% block head %}
{% endblock %}

{% block title %}
    {% trans "Bilder" %}
{% endblock %}

{% block content %}
    {% csrf_token %}
    {% if error %}
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            {{ error }}
        </div>
    {% else %}
        <div class="card rounded-4 mb-3">
            <div class="card-header rounded-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">{% trans "Bilder" %}</h3>
                    <a href="{% url 'bild' %}" class="btn btn-sm rounded-4 btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>{% trans "Bilder hinzufügen" %}
                    </a>
                </div> 

                {% if user.role == 'O' and person_clusters %}
                <div class="d-flex gap-1 justify-content-center align-items-center mt-2">
                    <strong>{% trans "Benutzergruppe" %}</strong>
                    <div class="gap-1 flex-wrap justify-content-center align-items-center d-none d-md-flex">
                        <a class="btn btn-sm rounded-4 {% if not current_person_cluster %}btn-primary{% else %}btn-outline-primary{% endif %} {% if not current_person_cluster %}active{% endif %}" href="{% url 'bilder' %}?person_cluster_filter=None">
                            {% trans 'Alle' %}
                        </a>
                        {% for person_cluster in person_clusters %}
                            <a class="btn btn-sm rounded-4 {% if current_person_cluster == person_cluster %}btn-primary{% else %}btn-outline-primary{% endif %} {% if current_person_cluster == person_cluster %}active{% endif %}" href="{% url 'bilder' %}?person_cluster_filter={{ person_cluster.id }}">
                                {{ person_cluster.name }}
                            </a>
                        {% endfor %}
                    </div>
                    <div class="d-flex gap-1 flex-wrap justify-content-center align-items-center d-md-none">
                        <select class="form-select form-select-sm rounded-4" onchange="window.location.href = this.value;">
                            <option value="{% url 'bilder' %}?person_cluster_filter=None">{% trans 'Alle' %}</option>
                            {% for person_cluster in person_clusters %}
                                <option value="{% url 'bilder' %}?person_cluster_filter={{ person_cluster.id }}" {% if current_person_cluster == person_cluster %}selected{% endif %}>
                                    {{ person_cluster.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% endif %}
                {% if not user.role == 'O' %}
                <div class="d-flex gap-1 justify-content-center align-items-center mt-2 flex-wrap">
                    <strong>{% trans "Filter" %}</strong>
                    <div class="gap-1 d-flex justify-content-center align-items-center flex-wrap">
                        <a class="btn btn-sm rounded-4 {% if not current_person_cluster %}btn-primary{% else %}btn-outline-primary{% endif %} {% if not current_person_cluster %}active{% endif %}" href="{% url 'bilder' %}?person_cluster_filter=None">
                            {% trans 'Alle' %}
                        </a>
                        {% with request.user.person_cluster as my_person_cluster %}
                            <a class="btn btn-sm rounded-4 {% if current_person_cluster.id == my_person_cluster.id %}btn-primary{% else %}btn-outline-primary{% endif %} {% if current_person_cluster.id == my_person_cluster.id %}active{% endif %}" href="{% url 'bilder' %}?person_cluster_filter={{ my_person_cluster.id }}">
                                {% trans "Nur" %} {{ my_person_cluster.name }}
                            </a>
                        {% endwith %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row g-4">
                    {% include 'bilder_show.html' with gallery_images=gallery_images %}
                </div>
            </div>
        </div> 
        
        {% if show_pagination and page_obj %}
            <nav class="d-flex justify-content-center mt-4 flex-wrap" aria-label="{% trans "Bilderseiten" %}">
                <ul class="pagination pagination-sm mb-0 flex-wrap">
                    <li class="page-item{% if not page_obj.has_previous %} disabled{% endif %}">
                        <a class="page-link rounded-4" href="{% if page_obj.has_previous %}{{ pagination_base_url }}page={{ page_obj.previous_page_number }}{% else %}#{% endif %}" aria-label="{% trans "Vorherige Seite" %}">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% for num in page_obj.paginator.page_range %}
                        <li class="page-item{% if page_obj.number == num %} active{% endif %}">
                            {% if page_obj.number == num %}
                                <span class="page-link rounded-4">{{ num }}</span>
                            {% else %}
                                <a class="page-link rounded-4" href="{{ pagination_base_url }}page={{ num }}">{{ num }}</a>
                            {% endif %}
                        </li>
                    {% endfor %}
                    <li class="page-item{% if not page_obj.has_next %} disabled{% endif %}">
                        <a class="page-link rounded-4" href="{% if page_obj.has_next %}{{ pagination_base_url }}page={{ page_obj.next_page_number }}{% else %}#{% endif %}" aria-label="{% trans "Nächste Seite" %}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    function showDeleteConfirmation(bildId, imageUrl, titel) {
        createModal('deleteModal', 
            '{% trans "Bild löschen" %}', 
            `<p>{% trans "Möchten Sie dieses Bild wirklich löschen?" %}</p>
            <div class="text-center">
                <img src="${imageUrl}" alt="${titel}" class="img-fluid rounded" style="max-height: 200px;">
            </div>`,
            `<a href="{% url 'remove_bild' %}?galleryImageId=${bildId}" class="btn btn-danger">{% trans "Löschen" %}</a>`
        );
    }

    function showDeleteConfirmationAll(bildId) {
        createModal('deleteAllModal', 
            '{% trans "Alle Bilder löschen" %}',
            '<p>{% trans "Möchten Sie wirklich alle Bilder dieser Galerie löschen?" %}</p>',
            `<a href="{% url 'remove_bild_all' %}?bild_id=${bildId}" class="btn btn-danger">{% trans "Alle löschen" %}</a>`
        );
    }

    function createModal(id, title, body, actionButton) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = id;
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">${body}</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Abbrechen" %}</button>
                        ${actionButton}
                    </div>
                </div>
            </div>`;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
    }
</script>
{% endblock %}