{% extends extends_base|default:'baseFw.html' %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}

{% block head %}
<script src="{% static 'js/bild.js' %}"></script>
<script>
function handleImageUpload(input) {
    const files = Array.from(input.files);
    const convertedFiles = [];
    let processedCount = 0;

    files.forEach((file, index) => {
        if (file.type === 'image/heic' || file.type === 'image/heif' || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')) {
            // Convert HEIC to JPEG
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob(function(blob) {
                    const convertedFile = new File([blob], file.name.replace(/\.(heic|heif)$/i, '.jpg'), {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    convertedFiles[index] = convertedFile;
                    processedCount++;
                    
                    if (processedCount === files.length) {
                        updateInputFiles(input, convertedFiles);
                    }
                }, 'image/jpeg', 0.9);
            };
            
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            convertedFiles[index] = file;
            processedCount++;
            
            if (processedCount === files.length) {
                updateInputFiles(input, convertedFiles);
            }
        }
    });
}

function updateInputFiles(input, files) {
    const dt = new DataTransfer();
    files.forEach(file => {
        if (file) dt.items.add(file);
    });
    input.files = dt.files;
}
</script>
{% endblock %}

{% block headline %}
{% trans "Bilder" %}
{% endblock %}

{% block content %}
<div class="card rounded-4">
    <div class="card-header">
        <h3 class="card-title mb-0">{% trans "Bilder hochladen" %}</h3>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="bilderForm">
            {% csrf_token %}
            {{ bilder_form.submission_key }}

            <div class="mb-3">
                {% for field in bilder_form %}
                    {% if field.name != 'submission_key' %}
                    <div class="form-group mb-3">
                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field|add_class:"form-control" }}
                        {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.errors %}
                        {% for error in field.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}

                {% include "components/fullscreen_drop_zone.html" %}
            </div>

            <div class="mb-3">
                {% for field in bilder_gallery_form %}
                <div class="form-group mb-3">
                    <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>

                    {% if field.name == 'image' %}
                    <div class="upload-container position-relative">
                        <input type="file" class="form-control" name="{{ field.name }}" id="{{ field.id_for_label }}" 
                               {% if not field.value %} required {% endif %} 
                               multiple="true"
                               accept="image/*"
                               style="z-index: 2;"
                               onchange="handleImageUpload(this)">
                        <div class="upload-overlay d-flex flex-column align-items-center justify-content-center position-absolute top-0 start-0 w-100 h-100"
                             style="z-index: 1; pointer-events: none;">
                             {% if field.value %}
                            <i class="bi bi-file-earmark-check display-4 text-success"></i>
                            <p class="mb-0 text-muted">{{ field.value|cut:"uploads/" }}</p>
                            <p class="mb-0 text-muted">{% trans "Datei hierher ziehen oder klicken zum Auswählen" %}</p>
                            {% else %}
                            <i class="bi bi-cloud-upload display-4 text-primary"></i>
                            <p class="mb-0 text-muted">{% trans "Datei hierher ziehen oder klicken zum Auswählen" %}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    {{ field|add_class:"form-control" }}
                    {% endif %}
                    {% if field.help_text %}
                    <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}
                    {% if field.errors %}
                    {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div id="previewContainer" class="mb-3"></div>

            <div class="d-flex justify-content-end">
                <button id="submitBtn" type="submit" class="btn btn-primary">
                    <span class="label d-flex align-items-center justify-content-center"><i class="bi bi-save me-2"></i>{% trans "Speichern" %}</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const form = document.getElementById('bilderForm');
    const submitBtn = document.getElementById('submitBtn');
    let submitted = false;

    // Generate UUID if not provided
    function genUUID() {
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
        const s = [];
        const hex = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
        for (let i = 0; i < hex.length; i++) {
            const c = hex[i];
            if (c === 'x' || c === 'y') {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                s.push(v.toString(16));
            } else {
                s.push(c);
            }
        }
        return s.join('');
    }

    let keyInput = document.querySelector('input[name="submission_key"]');
    if (keyInput && !keyInput.value) {
        keyInput.value = genUUID();
    }

    form.addEventListener('submit', (event) => {
        if (submitted) {
            event.preventDefault();
            return;
        }

        // Validate: at least one image selected
        const imageInput = document.querySelector('input[name="image"]');
        if (!imageInput || !imageInput.files || imageInput.files.length === 0) {
            event.preventDefault();
            alert('{% trans "Bitte wählen Sie mindestens ein Bild aus" %}');
            return;
        }

        // Lock UI
        submitted = true;
        submitBtn.disabled = true;
        const label = submitBtn.querySelector('.label');
        const spinner = submitBtn.querySelector('.spinner-border');
        if (label) label.classList.add('d-none');
        if (spinner) spinner.classList.remove('d-none');
        
        // Make inputs read-only but don't disable them (disabled fields don't get submitted)
        form.querySelectorAll('input:not([type="hidden"]), textarea').forEach(el => {
            el.readOnly = true;
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.6';
        });
        
        // Disable drop zone
        const dropZone = document.getElementById('fullscreenDropZone');
        if (dropZone) {
            dropZone.style.display = 'none';
            dropZone.style.pointerEvents = 'none';
        }
        
        // Disable drag and drop on the document
        document.body.style.pointerEvents = 'none';
        // But allow the form to still be interactive for submission
        form.style.pointerEvents = 'auto';
    });
})();
</script>

{% endblock %}