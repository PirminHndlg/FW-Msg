{% extends 'baseTeam.html' %}
{% load i18n %}
{% load static %}

{% block title %}
  Team Dashboard
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/list_ampel.css' %}">
  <style>
    .dashboard-section {
      margin-bottom: 2rem;
    }
    
    .section-header {
      border-bottom: 2px solid #f8f9fa;
      padding-bottom: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #495057;
      margin: 0;
    }
    
    .card-compact {
      border: 1px solid #e9ecef;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .country-flag {
      width: 24px;
      height: auto;
      border-radius: 2px;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
    
    .country-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .country-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .ampel-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.25rem;
    }

    /* Dashboard Header Styling */
    .dashboard-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 1rem;
      padding: 1.5rem;
      border: 1px solid #dee2e6;
      margin-bottom: 2rem !important;
    }

    .country-flags {
      background: rgba(255, 255, 255, 0.7);
      padding: 0.25rem 0.75rem;
      border-radius: 2rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .flag-container {
      position: relative;
      transition: transform 0.2s ease;
    }

    .flag-container:hover {
      transform: scale(1.1);
    }

    .country-flag-header {
      width: 28px;
      height: 20px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      display: inline-block;
    }

    .quick-stats {
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-item {
      min-width: 80px;
    }

    .stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      line-height: 1;
    }

    .team-info .badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    @media (max-width: 768px) {
      .dashboard-header {
        padding: 1rem;
      }

      .country-flags {
        margin-top: 0.5rem;
        width: 100%;
        justify-content: center;
      }

      .quick-stats {
        margin-top: 1rem;
        justify-content: center !important;
      }

      .stat-number {
        font-size: 1.5rem;
      }
    }
  </style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-4">
  <div class="d-flex align-items-center justify-content-between">
    <h1 class="h2 mb-0 me-3">{% trans "Dashboard" %}</h1>
    {% if assigned_countries %}
      <a href="{% url 'laender_info' %}" class="text-decoration-none">
        <div class="country-flags d-flex align-items-center">
          <small class="text-muted me-2">{% trans "Meine LÃ¤nder:" %}</small>
          {% for stat in country_stats %}
            <div class="flag-container me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ stat.country.name }}">
              <span class="fi fi-{{ stat.country.code|lower }} country-flag-header"></span>
            </div>
          {% endfor %}
        </div>
      </a>
    {% endif %}
  </div>

  {% if not assigned_countries %}
    <div class="alert alert-warning border-0 mt-3" role="alert">
      <div class="d-flex align-items-center">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <div>
          <strong>LÃ¤nder-Zuordnung erforderlich</strong><br>
          <small>
            Melde dich bei 
            <a href="mailto:{{ team_member.org.email }}" class="alert-link">
              <i class="bi bi-envelope me-1"></i>{{ team_member.org.name }}
            </a> 
            um Zugriff auf deine EinsatzlÃ¤nder zu erhalten.
          </small>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Welcome Message for New Users -->
<div class="dashboard-section">
  <div class="card card-compact border-primary">
    <div class="card-body text-center py-4">
      <i class="bi bi-lightbulb text-primary mb-3" style="font-size: 3rem;"></i>
      <h3 class="mb-3">Hast du Anregungen oder Feedback zum Dashboard?</h3>
      <p class="text-muted mb-4">
        Dieses Dashboard befindet sich noch in der Entwicklung.<br>
        Teile uns gerne deine Ideen oder WÃ¼nsche mit. Gerne auch zu anderen Seiten ðŸ‘€
      </p>
      <a href="{% url 'feedback' %}" class="btn btn-primary">
        <i class="bi bi-chat-dots me-2"></i>Feedback senden
      </a>
      <p class="text-muted mt-4 mb-0">
        Falls dir Fehler auffallen, gib uns bitte Bescheid.
      </p>
    </div>
  </div>
</div>

<!-- Quick Stats Section -->
<div class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">
      <i class="bi bi-speedometer2 me-2 text-primary"></i>
      Ãœbersicht
    </h2>
  </div>

  <div class="grid-3">
    <!-- Total Volunteers -->
    <div class="card card-compact h-100">
      <div class="card-body text-center">
        <i class="bi bi-people-fill text-primary mb-3" style="font-size: 2.5rem;"></i>
        <div class="h2 mb-2 text-primary">{{ freiwillige_count }}</div>
        <p class="mb-0 text-muted">Freiwillige gesamt</p>
        <a href="{% url 'team_contacts' %}" class="btn btn-sm btn-outline-primary mt-2">
          Kontakte anzeigen
        </a>
      </div>
    </div>

    <!-- Total Placement Locations -->
    <div class="card card-compact h-100">
      <div class="card-body text-center">
        <i class="bi bi-geo-alt-fill text-info mb-3" style="font-size: 2.5rem;"></i>
        <div class="h2 mb-2 text-info">{{ einsatzstellen_count }}</div>
        <p class="mb-0 text-muted">Einsatzstellen</p>
        <a href="{% url 'einsatzstellen_info' %}" class="btn btn-sm btn-outline-info mt-2">
          Verwalten
        </a>
      </div>
    </div>

    <!-- Countries Assigned -->
    <div class="card card-compact h-100">
      <div class="card-body text-center">
        <i class="bi bi-flag-fill text-success mb-3" style="font-size: 2.5rem;"></i>
        <div class="h2 mb-2 text-success">{{ assigned_countries|length }}</div>
        <p class="mb-0 text-muted">Zugewiesene LÃ¤nder</p>
        <a href="{% url 'laender_info' %}" class="btn btn-sm btn-outline-success mt-2">
          LÃ¤nder verwalten
        </a>
      </div>
    </div>
  </div>
</div>

<!-- My Tasks Section -->
{% if request.user.customuser.person_cluster.aufgaben %}
<div class="dashboard-section">
  <div class="section-header">
    <h2 class="section-title">
      <i class="bi bi-list-task me-2 text-primary"></i>
      {% trans 'Meine Aufgaben' %}
    </h2>
  </div>

  <div class="card card-compact">
    <div class="card-header bg-white border-bottom-0">
      <div class="d-flex justify-content-between align-items-center">
        <a href="{% url 'aufgaben' %}" class="text-decoration-none text-body">
          <h5 class="mb-0">
            <i class="bi bi-person-check me-2"></i>
            {% trans 'Offene Aufgaben' %}
          </h5>
        </a>
        <span class="badge bg-primary rounded-pill">{{ my_open_tasks.count }}</span>
      </div>
    </div>
    <div class="card-body">
      {% if my_open_tasks %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
          {% for task in my_open_tasks|slice:':6' %}
            {% include 'components/task_card.html' with task=task %}
          {% endfor %}
        </div>
        {% if my_open_tasks.count > 6 %}
          <div class="text-center mt-4 pt-3 border-top">
            <a href="{% url 'aufgaben' %}" class="btn btn-outline-primary">
              <i class="bi bi-list-task me-2"></i>
              {% trans 'Alle' %} {{ my_open_tasks.count }} {% trans 'Aufgaben anzeigen' %}
            </a>
          </div>
        {% endif %}
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-check2-circle text-success mb-3" style="font-size: 3rem;"></i>
          <h4 class="mb-2 text-success">{% trans 'Alle erledigt!' %}</h4>
          <p class="text-muted mb-0">
            {% trans 'Du hast keine offenen Aufgaben.' %}
          </p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

  <!-- Status & Content Section -->
  {% if recent_ampel_entries or posts or gallery_images %}
    <div class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-activity me-2 text-primary"></i>
          Aktuelle AktivitÃ¤ten
        </h2>
      </div>

      <div class="row g-3">
        <!-- Recent Ampel Entries -->
          <div class="card card-compact col-12 col-md-6 col-lg-3">
            <div class="card-header bg-white border-bottom-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-traffic-light me-2"></i>
                  Ampelmeldungen
                </h5>
                <small class="text-muted">Letzte 7 Tage</small>
              </div>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                {% for entry in recent_ampel_entries %}
                  <div class="list-group-item px-0 border-0 py-2 cursor-pointer" onclick="showAmpelComment({{ entry.id }}, '{{ entry.date }}', '{{ entry.status }}', '{{ entry.comment|default:'-ohne Kommentar- '|escapejs }}', '{{ entry.user.get_full_name|default:entry.user.username }}', '{{entry.read}}')">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="me-auto">
                        <div class="d-flex align-items-center mb-1">
                          <span class="status-indicator {% if entry.status == 'G' %}
                              bg-success
                            {% elif entry.status == 'Y' %}
                              bg-warning
                            {% else %}
                              bg-danger
                            {% endif %}">
                          </span>
                          <strong>{{ entry.user.get_full_name|default:entry.user.username }}</strong>
                        </div>
                        {% if entry.comment %}
                          <small class="text-muted">{{ entry.comment|truncatewords:8 }}</small>
                        {% endif %}
                      </div>
                      <small class="text-muted">{{ entry.date|date:'d.m H:i' }}</small>
                    </div>
                  </div>
                {% endfor %}
                {% include 'components/ampel_modal.html' %}
              </div>
              <div class="text-center mt-3">
                <a href="{% url 'team_ampelmeldung' %}" class="btn btn-sm btn-outline-primary">Alle anzeigen</a>
              </div>
            </div>
          </div>

        <!-- Recent Posts -->
          <div class="card card-compact h-100 col-12 col-md-6 col-lg-3">
            <div class="card-header bg-white border-bottom-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-newspaper me-2"></i>
                  Neueste Posts
                </h5>
              </div>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                {% for post in posts %}
                <a href="{% url 'post_detail' post.id %}" class="text-decoration-none">
                  <div class="list-group-item px-0 border-0 py-2">
                    <h6 class="mb-1">{{ post.title }}</h6>
                    <p class="mb-1 text-muted small">{{ post.text|truncatewords:15 }}</p>
                    <small class="text-muted">
                      <i class="bi bi-person me-1"></i>{{ post.user.get_full_name|default:post.user.username }}
                      <i class="bi bi-calendar ms-2 me-1"></i>{{ post.date|date:'d.m.Y' }}
                    </small>
                  </div>
                </a>
                {% endfor %}
              </div>
              <div class="text-center mt-3">
                <a href="{% url 'posts_overview' %}" class="btn btn-sm btn-outline-primary">Alle Posts</a>
              </div>
            </div>
          </div>

        <!-- Recent Images -->
          <div class="card card-compact h-100 col-12 col-lg-6">
            <div class="card-header bg-white border-bottom-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-images me-2"></i>
                  Neueste Bilder
                </h5>
              </div>
            </div>
            <div class="card-body">
              <!-- Image Carousel -->
              <div id="recentImagesCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                <div class="carousel-inner">
                  {% if gallery_images %}
                      <div class="row g-1">
                          {% include 'bilder_show.html' with gallery_images=gallery_images small=True %}
                      </div>
                  {% else %}
                      <div class="text-center py-4">
                  <i class="bi bi-images text-muted mb-2" style="font-size: 2rem"></i>
                          <p class="text-muted mb-0">{% trans "Keine Bilder vorhanden" %}</p>
                      </div>
                  {% endif %}
                </div>

                {% if gallery_images|length > 1 %}
                  <!-- Carousel Controls -->
                  <button class="carousel-control-prev" type="button" data-bs-target="#recentImagesCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon bg-dark bg-opacity-50 rounded-circle" aria-hidden="true"></span>
                    <span class="visually-hidden">Vorheriges</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#recentImagesCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon bg-dark bg-opacity-50 rounded-circle" aria-hidden="true"></span>
                    <span class="visually-hidden">NÃ¤chstes</span>
                  </button>
                {% endif %}
              </div>

              <div class="text-center">
                <a href="{% url 'bilder' %}" class="btn btn-sm btn-outline-primary">Alle Bilder</a>
              </div>
            </div>
          </div>
        </div>
    </div>
  {% endif %}

  {% if request.user.customuser.person_cluster.calendar %}
    {% include 'components/calendar.html' %}
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize tooltips if needed
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })
    })
  </script>
{% endblock %}
