{% extends 'baseTeam.html' %}
{% load i18n %}

{% block title %}
  {% trans 'Einsatzländer' %}| {{ user.org.name }}
{% endblock %}

{% block head %}
  <style>
    .country-card {
      transition: all 0.3s ease;
      border-radius: 1rem;
      border: none;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      height: 100%;
      overflow: hidden;
    }
    .country-card .card-header {
      border-radius: 1rem 1rem 0 0;
      border: none;
      padding: 1rem 1.25rem;
    }
    .country-card .card-body {
      padding: 1.25rem;
    }
    .info-section {
      margin-bottom: 1.5rem;
    }
    .info-section:last-child {
      margin-bottom: 0;
    }
    .info-section h5 {
      color: var(--bs-primary);
      border-bottom: 1px solid rgba(var(--bs-primary-rgb), 0.2);
      padding-bottom: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
    }
    .info-section h5 i {
      margin-right: 0.5rem;
    }
    .info-content {
      padding-left: 1.5rem;
      font-size: 0.95rem;
    }
    .edit-form textarea {
      min-height: 120px;
      border-radius: 0.5rem;
      padding: 0.75rem;
      border: 1px solid rgba(var(--bs-secondary-rgb), 0.2);
    }
    .edit-form textarea:focus {
      border-color: rgba(var(--bs-primary-rgb), 0.5);
      box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }
    .btn-primary {
      border-radius: 0.5rem;
      padding: 0.5rem 1.5rem;
      font-weight: 500;
    }
    .badge {
      font-weight: 500;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
    }
    .edit-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 10;
    }
    .empty-info {
      color: var(--bs-secondary);
      font-style: italic;
      font-size: 0.9rem;
    }
    .empty-info i {
      margin-right: 0.25rem;
    }
    .modal-header {
      background-color: var(--bs-primary);
      color: white;
    }
    .modal-content {
      border-radius: 0.75rem;
      border: none;
      overflow: hidden;
    }
  </style>
{% endblock %}

{% block content %}
  <h2 class="">{% trans 'Einsatzländer' %}</h2>

  {% if laender %}
    <div class="row row-cols-1 row-cols-lg-2 g-4">
      {% for land in laender %}
        <div class="col">
          <div class="card country-card position-relative" data-country-id="{{ land.id }}">
            <!-- Edit Button -->
            <button class="btn btn-sm btn-light edit-button" data-bs-toggle="modal" data-bs-target="#editModal-{{ land.id }}" title="{% trans 'Bearbeiten' %}"><i class="bi bi-pencil"></i></button>

            <!-- Country Header -->
            <div class="card-header bg-primary text-white">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 fw-bold">{{ land.name }}</h5>
              </div>
            </div>

            <!-- Country Information -->
            <div class="card-body">
              <!-- Emergency Numbers Section -->
              <div class="info-section">
                <h5><i class="bi bi-telephone-fill text-primary"></i> {% trans 'Notfallnummern' %}</h5>
                <div class="info-content">
                  {% if land.notfallnummern %}
                    {{ land.notfallnummern|linebreaks }}
                  {% else %}
                    <div class="empty-info">
                      <i class="bi bi-exclamation-circle"></i>{% trans 'Keine Notfallnummern hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Medical Practices Section -->
              <div class="info-section">
                <h5><i class="bi bi-hospital text-primary"></i> {% trans 'Arztpraxen' %}</h5>
                <div class="info-content">
                  {% if land.arztpraxen %}
                    {{ land.arztpraxen|linebreaks }}
                  {% else %}
                    <div class="empty-info">
                      <i class="bi bi-exclamation-circle"></i>{% trans 'Keine Arztpraxen hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Pharmacies Section -->
              <div class="info-section">
                <h5><i class="bi bi-capsule text-primary"></i> {% trans 'Apotheken' %}</h5>
                <div class="info-content">
                  {% if land.apotheken %}
                    {{ land.apotheken|linebreaks }}
                  {% else %}
                    <div class="empty-info">
                      <i class="bi bi-exclamation-circle"></i>{% trans 'Keine Apotheken hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Additional Information Section -->
              <div class="info-section">
                <h5><i class="bi bi-info-circle text-primary"></i> {% trans 'Weitere Informationen' %}</h5>
                <div class="info-content">
                  {% if land.informationen %}
                    {{ land.informationen|linebreaks }}
                  {% else %}
                    <div class="empty-info">
                      <i class="bi bi-exclamation-circle"></i>{% trans 'Keine weiteren Informationen hinterlegt' %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Modal -->
          <div class="modal fade" id="editModal-{{ land.id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ land.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editModalLabel-{{ land.id }}"><i class="bi bi-pencil-square me-2"></i>{% trans 'Informationen bearbeiten' %}: {{ land.name }}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form method="post" action="{% url 'team_save_land_info' land.id %}" class="edit-form">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="notfallnummern-{{ land.id }}" class="form-label fw-medium"><i class="bi bi-telephone-fill me-2 text-primary"></i> {% trans 'Notfallnummern' %}</label>
                      <textarea class="form-control" id="notfallnummern-{{ land.id }}" name="notfallnummern" placeholder="{% trans 'Notfallnummern hier eingeben...' %}">{{ land.notfallnummern|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="arztpraxen-{{ land.id }}" class="form-label fw-medium"><i class="bi bi-hospital me-2 text-primary"></i> {% trans 'Arztpraxen' %}</label>
                      <textarea class="form-control" id="arztpraxen-{{ land.id }}" name="arztpraxen" placeholder="{% trans 'Arztpraxen hier eingeben...' %}">{{ land.arztpraxen|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                      <label for="apotheken-{{ land.id }}" class="form-label fw-medium"><i class="bi bi-capsule me-2 text-primary"></i> {% trans 'Apotheken' %}</label>
                      <textarea class="form-control" id="apotheken-{{ land.id }}" name="apotheken" placeholder="{% trans 'Apotheken hier eingeben...' %}">{{ land.apotheken|default:'' }}</textarea>
                    </div>

                    <div class="mb-4">
                      <label for="informationen-{{ land.id }}" class="form-label fw-medium"><i class="bi bi-info-circle me-2 text-primary"></i> {% trans 'Weitere Informationen' %}</label>
                      <textarea class="form-control" id="informationen-{{ land.id }}" name="informationen" placeholder="{% trans 'Weitere Informationen hier eingeben...' %}">{{ land.informationen|default:'' }}</textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-2"></i>{% trans 'Abbrechen' %}</button>
                      <button type="submit" class="btn btn-primary"><i class="bi bi-save me-2"></i>{% trans 'Änderungen speichern' %}</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info rounded-3">
      <i class="bi bi-info-circle me-2"></i>{% trans 'Keine Einsatzländer gefunden. Bitte wenden Sie sich an den Administrator, um Einsatzländer zugewiesen zu bekommen.' %}
    </div>
  {% endif %}

  <script>
    // Auto-highlight saved country from URL parameter
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search)
      const savedId = urlParams.get('saved')
    
      if (savedId && savedId !== 'true') {
        // Find the country card and highlight it temporarily
        const countryCard = document.querySelector(`.card[data-country-id="${savedId}"]`)
        if (countryCard) {
          countryCard.classList.add('border-success')
          setTimeout(() => {
            countryCard.classList.remove('border-success')
          }, 3000)
    
          // Scroll to the saved country
          countryCard.scrollIntoView({ behavior: 'smooth', block: 'center' })
        }
      }
    })
  </script>
{% endblock %}
